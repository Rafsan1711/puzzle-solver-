<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Periodic Table</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- three.js -->
  <script src="./three.js"></script>
  <style>
    /* [All the CSS from previous message remains unchanged, for brevity not repeated here] */
    /* ... */
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    // ==== FIREBASE CONFIG ====
    const firebaseConfig = {
      apiKey: "AIzaSyCMEqtaxOodPnwMKkrSVZrcjLMmj3oefB0",
      authDomain: "chatstudio-agent.firebaseapp.com",
      databaseURL: "https://chatstudio-agent-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatstudio-agent",
      storageBucket: "chatstudio-agent.appspot.com",
      messagingSenderId: "626338448826",
      appId: "1:626338448826:web:67936971701c3466d90983",
      measurementId: "G-ZHNZHMYC0B"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
  </script>
  <script>
/* == Periodic Table Layout Data == */
// 1-118, row, col, symbol, name, defaults. Use this structure to draw the table as in the image
const periodicTableLayout = [
  // row, col, atomicNumber, symbol, name, defaultColor
  [1, 1, 1, "H", "Hydrogen", "#7DFDFE"],
  [1, 18, 2, "He", "Helium", "#E7CFFF"],
  [2, 1, 3, "Li", "Lithium", "#FFB3B3"],
  [2, 2, 4, "Be", "Beryllium", "#FFEC99"],
  [2, 13, 5, "B", "Boron", "#FFE48E"],
  [2, 14, 6, "C", "Carbon", "#D3F9D8"],
  [2, 15, 7, "N", "Nitrogen", "#AFD7FF"],
  [2, 16, 8, "O", "Oxygen", "#B3DFFD"],
  [2, 17, 9, "F", "Fluorine", "#FFD6E0"],
  [2, 18, 10, "Ne", "Neon", "#E7CFFF"],
  [3, 1, 11, "Na", "Sodium", "#FFB3B3"],
  [3, 2, 12, "Mg", "Magnesium", "#FFEC99"],
  [3, 13, 13, "Al", "Aluminum", "#FFE48E"],
  [3, 14, 14, "Si", "Silicon", "#D3F9D8"],
  [3, 15, 15, "P", "Phosphorus", "#AFD7FF"],
  [3, 16, 16, "S", "Sulfur", "#B3DFFD"],
  [3, 17, 17, "Cl", "Chlorine", "#FFD6E0"],
  [3, 18, 18, "Ar", "Argon", "#E7CFFF"],
  [4, 1, 19, "K", "Potassium", "#FFB3B3"],
  [4, 2, 20, "Ca", "Calcium", "#FFEC99"],
  [4, 3, 21, "Sc", "Scandium", "#B4E3E1"],
  [4, 4, 22, "Ti", "Titanium", "#B4E3E1"],
  [4, 5, 23, "V", "Vanadium", "#B4E3E1"],
  [4, 6, 24, "Cr", "Chromium", "#B4E3E1"],
  [4, 7, 25, "Mn", "Manganese", "#B4E3E1"],
  [4, 8, 26, "Fe", "Iron", "#B4E3E1"],
  [4, 9, 27, "Co", "Cobalt", "#B4E3E1"],
  [4, 10, 28, "Ni", "Nickel", "#B4E3E1"],
  [4, 11, 29, "Cu", "Copper", "#B4E3E1"],
  [4, 12, 30, "Zn", "Zinc", "#B4E3E1"],
  [4, 13, 31, "Ga", "Gallium", "#FFE48E"],
  [4, 14, 32, "Ge", "Germanium", "#D3F9D8"],
  [4, 15, 33, "As", "Arsenic", "#AFD7FF"],
  [4, 16, 34, "Se", "Selenium", "#B3DFFD"],
  [4, 17, 35, "Br", "Bromine", "#FFD6E0"],
  [4, 18, 36, "Kr", "Krypton", "#E7CFFF"],
  [5, 1, 37, "Rb", "Rubidium", "#FFB3B3"],
  [5, 2, 38, "Sr", "Strontium", "#FFEC99"],
  [5, 3, 39, "Y", "Yttrium", "#B4E3E1"],
  [5, 4, 40, "Zr", "Zirconium", "#B4E3E1"],
  [5, 5, 41, "Nb", "Niobium", "#B4E3E1"],
  [5, 6, 42, "Mo", "Molybdenum", "#B4E3E1"],
  [5, 7, 43, "Tc", "Technetium", "#B4E3E1"],
  [5, 8, 44, "Ru", "Ruthenium", "#B4E3E1"],
  [5, 9, 45, "Rh", "Rhodium", "#B4E3E1"],
  [5, 10, 46, "Pd", "Palladium", "#B4E3E1"],
  [5, 11, 47, "Ag", "Silver", "#B4E3E1"],
  [5, 12, 48, "Cd", "Cadmium", "#B4E3E1"],
  [5, 13, 49, "In", "Indium", "#FFE48E"],
  [5, 14, 50, "Sn", "Tin", "#D3F9D8"],
  [5, 15, 51, "Sb", "Antimony", "#AFD7FF"],
  [5, 16, 52, "Te", "Tellurium", "#B3DFFD"],
  [5, 17, 53, "I", "Iodine", "#FFD6E0"],
  [5, 18, 54, "Xe", "Xenon", "#E7CFFF"],
  [6, 1, 55, "Cs", "Cesium", "#FFB3B3"],
  [6, 2, 56, "Ba", "Barium", "#FFEC99"],
  [6, 3, 57, "La", "Lanthanum", "#B4E3E1"],
  [6, 4, 72, "Hf", "Hafnium", "#B4E3E1"],
  [6, 5, 73, "Ta", "Tantalum", "#B4E3E1"],
  [6, 6, 74, "W", "Tungsten", "#B4E3E1"],
  [6, 7, 75, "Re", "Rhenium", "#B4E3E1"],
  [6, 8, 76, "Os", "Osmium", "#B4E3E1"],
  [6, 9, 77, "Ir", "Iridium", "#B4E3E1"],
  [6, 10, 78, "Pt", "Platinum", "#B4E3E1"],
  [6, 11, 79, "Au", "Gold", "#B4E3E1"],
  [6, 12, 80, "Hg", "Mercury", "#B4E3E1"],
  [6, 13, 81, "Tl", "Thallium", "#FFE48E"],
  [6, 14, 82, "Pb", "Lead", "#D3F9D8"],
  [6, 15, 83, "Bi", "Bismuth", "#AFD7FF"],
  [6, 16, 84, "Po", "Polonium", "#B3DFFD"],
  [6, 17, 85, "At", "Astatine", "#FFD6E0"],
  [6, 18, 86, "Rn", "Radon", "#E7CFFF"],
  [7, 1, 87, "Fr", "Francium", "#FFB3B3"],
  [7, 2, 88, "Ra", "Radium", "#FFEC99"],
  [7, 3, 89, "Ac", "Actinium", "#B4E3E1"],
  [7, 4, 104, "Rf", "Rutherfordium", "#B4E3E1"],
  [7, 5, 105, "Db", "Dubnium", "#B4E3E1"],
  [7, 6, 106, "Sg", "Seaborgium", "#B4E3E1"],
  [7, 7, 107, "Bh", "Bohrium", "#B4E3E1"],
  [7, 8, 108, "Hs", "Hassium", "#B4E3E1"],
  [7, 9, 109, "Mt", "Meitnerium", "#B4E3E1"],
  [7, 10, 110, "Ds", "Darmstadtium", "#B4E3E1"],
  [7, 11, 111, "Rg", "Roentgenium", "#B4E3E1"],
  [7, 12, 112, "Cn", "Copernicium", "#B4E3E1"],
  [7, 13, 113, "Nh", "Nihonium", "#FFE48E"],
  [7, 14, 114, "Fl", "Flerovium", "#D3F9D8"],
  [7, 15, 115, "Mc", "Moscovium", "#AFD7FF"],
  [7, 16, 116, "Lv", "Livermorium", "#B3DFFD"],
  [7, 17, 117, "Ts", "Tennessine", "#FFD6E0"],
  [7, 18, 118, "Og", "Oganesson", "#E7CFFF"],
  // Lanthanides
  [8, 4, 58, "Ce", "Cerium", "#A2E2C2"],
  [8, 5, 59, "Pr", "Praseodymium", "#A2E2C2"],
  [8, 6, 60, "Nd", "Neodymium", "#A2E2C2"],
  [8, 7, 61, "Pm", "Promethium", "#A2E2C2"],
  [8, 8, 62, "Sm", "Samarium", "#A2E2C2"],
  [8, 9, 63, "Eu", "Europium", "#A2E2C2"],
  [8, 10, 64, "Gd", "Gadolinium", "#A2E2C2"],
  [8, 11, 65, "Tb", "Terbium", "#A2E2C2"],
  [8, 12, 66, "Dy", "Dysprosium", "#A2E2C2"],
  [8, 13, 67, "Ho", "Holmium", "#A2E2C2"],
  [8, 14, 68, "Er", "Erbium", "#A2E2C2"],
  [8, 15, 69, "Tm", "Thulium", "#A2E2C2"],
  [8, 16, 70, "Yb", "Ytterbium", "#A2E2C2"],
  [8, 17, 71, "Lu", "Lutetium", "#A2E2C2"],
  // Actinides
  [9, 4, 90, "Th", "Thorium", "#A2E2C2"],
  [9, 5, 91, "Pa", "Protactinium", "#A2E2C2"],
  [9, 6, 92, "U", "Uranium", "#A2E2C2"],
  [9, 7, 93, "Np", "Neptunium", "#A2E2C2"],
  [9, 8, 94, "Pu", "Plutonium", "#A2E2C2"],
  [9, 9, 95, "Am", "Americium", "#A2E2C2"],
  [9, 10, 96, "Cm", "Curium", "#A2E2C2"],
  [9, 11, 97, "Bk", "Berkelium", "#A2E2C2"],
  [9, 12, 98, "Cf", "Californium", "#A2E2C2"],
  [9, 13, 99, "Es", "Einsteinium", "#A2E2C2"],
  [9, 14, 100, "Fm", "Fermium", "#A2E2C2"],
  [9, 15, 101, "Md", "Mendelevium", "#A2E2C2"],
  [9, 16, 102, "No", "Nobelium", "#A2E2C2"],
  [9, 17, 103, "Lr", "Lawrencium", "#A2E2C2"]
];
const ownerEmail = "owner@gmail.com";

// Helper: (row, col) â†’ index in 2D table grid
function getTableGrid() {
  // 9 rows, 18 columns (inc. 2 f-blocks below)
  const grid = [];
  for (let r = 0; r < 9; r++) grid.push(Array(18).fill(null));
  for (const el of periodicTableLayout) {
    let [row, col, num, sym, name, color] = el;
    grid[row-1][col-1] = {atomic: num, symbol: sym, name, color};
  }
  return grid;
}
const tableGrid = getTableGrid();

// Routing helpers
function getRoute() {
  // Returns {screen: "auth"|"table"|"atom", atomSlug?:string}
  const path = window.location.pathname.replace(/^\//,'').toLowerCase();
  if (!window.currentUser) return {screen: "auth"};
  if (!path || path === "") return {screen:"table"};
  // /hydrogen etc
  for (const el of periodicTableLayout) {
    let slug = el[4].toLowerCase();
    if (path === slug) return {screen:"atom", atomSlug:slug};
  }
  return {screen:"table"};
}
function goToAtom(slug) {
  history.pushState({}, "", "/" + slug);
  renderApp();
}
function goToTable() {
  history.pushState({}, "", "/");
  renderApp();
}

// Firebase atom data fetch (once, then on-change listener for live)
let atomsData = {}; // {atomic: {symbol, name, proton, electron, neutron, color}}
function subscribeAtomData() {
  db.ref("atoms").on("value", snap => {
    atomsData = snap.val() || {};
    renderApp();
  });
}
subscribeAtomData();

// User session state
window.currentUser = null;
auth.onAuthStateChanged(user => {
  window.currentUser = user;
  renderApp();
});

// Routing: handle browser navigation
window.onpopstate = () => renderApp();

// ------------------- RENDER MAIN APP -------------------
function renderApp() {
  const app = document.getElementById("app");
  app.innerHTML = "";
  const route = getRoute();
  if (!window.currentUser) {
    app.appendChild(renderAuthScreen());
    return;
  }
  // Header
  app.appendChild(renderHeader(window.currentUser));
  // Main
  if (route.screen === "table") {
    app.appendChild(renderPeriodicTableScreen());
  } else if (route.screen === "atom") {
    app.appendChild(renderAtomScreen(route.atomSlug));
  }
}
// ------------------ AUTH SCREEN ------------------------
function renderAuthScreen() {
  const div = document.createElement("div");
  div.className = "auth-screen";
  div.innerHTML = `
    <div class="auth-card">
      <div class="auth-title">3D Periodic Table</div>
      <button class="sign-btn" id="signInBtn">
        <svg width="25" height="25" style="vertical-align:middle;margin-right:0.4em" viewBox="0 0 48 48"><g><path fill="#FFC107" d="M43.6 20.5H42V20.5H24V27.5H35.1C33.8 31.4 30.3 34 25.9 34C20.6 34 16.1 29.5 16.1 24.2C16.1 18.9 20.6 14.4 25.9 14.4C28.3 14.4 30.4 15.3 32 16.8L37.1 11.7C34.1 8.9 30.3 7 25.9 7C15.9 7 7.9 15.1 7.9 25.1C7.9 35.1 15.9 43.1 25.9 43.1C37.1 43.1 44.1 34.1 44.1 25.1C44.1 23.7 44 22.5 43.6 20.5Z"></path><path fill="#FF3D00" d="M6 14.6L12.1 19.2C14 15.3 18.3 12.1 24 12.1C26.8 12.1 29.3 13.1 31.3 14.7L37.1 8.9C33.3 5.7 28.2 3.5 24 3.5C15.7 3.5 8.6 9.2 6 14.6Z"></path><path fill="#4CAF50" d="M24 44.2C30.2 44.2 35.9 41.8 39.7 37.5L33.1 32.1C31.2 33.6 28.8 34.7 25.9 34.7C21.5 34.7 18 31.1 16.7 27.2L6 32.4C8.7 38.3 15.6 44.2 24 44.2Z"></path><path fill="#1976D2" d="M43.6 20.5H42V20.5H24V27.5H35.1C34.7 29.2 33.8 30.7 32.7 32L39.7 37.5C42.7 34.5 44.2 30.2 44.2 25.1C44.2 23.7 44.1 22.5 43.6 20.5Z"></path></g></svg>
        Sign in with Google
      </button>
    </div>
  `;
  div.querySelector("#signInBtn").onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  };
  return div;
}
// ------------------ HEADER -----------------------------
function renderHeader(user) {
  const d = document.createElement("div");
  d.className = "header";
  d.innerHTML = `
    <div class="header-title">3D Periodic Table</div>
    <div class="header-user">
      <img src="${user.photoURL}" alt="user"/>
      <span>${user.displayName || user.email}</span>
      <button class="logout-btn">Logout</button>
    </div>
  `;
  d.querySelector(".logout-btn").onclick = () => {
    auth.signOut();
  };
  d.querySelector(".header-title").onclick = () => goToTable();
  return d;
}
// ------------------ PERIODIC TABLE SCREEN --------------
function renderPeriodicTableScreen() {
  const wrap = document.createElement("div");
  wrap.className = "periodic-wrap";
  const table = document.createElement("div");
  table.className = "periodic-table";
  // Build grid: 9 rows x 18 cols
  for (let r = 0; r < 9; r++) {
    for (let c = 0; c < 18; c++) {
      const block = document.createElement("div");
      block.className = "element-block";
      const el = tableGrid[r][c];
      if (!el) {
        block.setAttribute("data-empty", "1");
        table.appendChild(block);
        continue;
      }
      // Owner highlight
      if (window.currentUser.email === ownerEmail) block.classList.add("owner-editable");
      // Color
      if (atomsData[el.atomic] && atomsData[el.atomic].color)
        block.style.background = atomsData[el.atomic].color;
      else if (el.color) block.style.background = el.color;
      // Data
      const atom = atomsData[el.atomic];
      block.innerHTML = `
        <div class="block-atomic-num">${el.atomic}</div>
        <div class="block-symbol">${atom?.symbol || el.symbol}</div>
        <div class="block-full-name">${atom?.name || el.name}</div>
      `;
      // Click, Double Click logic
      block.onclick = () => goToAtom((atom?.name || el.name).toLowerCase());
      // Double click: only for owner
      block.ondblclick = (e) => {
        e.preventDefault();
        if (window.currentUser.email !== ownerEmail) return;
        openAtomEditModal(el.atomic);
      };
      table.appendChild(block);
    }
  }
  wrap.appendChild(table);
  return wrap;
}
// ------------------ ATOM EDIT MODAL (Owner) ------------
function openAtomEditModal(atomic) {
  const atom = atomsData[atomic] || {};
  const el = periodicTableLayout.find(e => e[2] === atomic);
  if (!el) return;
  const modalBg = document.createElement("div");
  modalBg.className = "modal-bg";
  // Modal HTML
  modalBg.innerHTML = `
    <div class="modal">
      <button class="modal-close-btn">&times;</button>
      <div class="modal-title">${el[4]} (${el[3]}) - Edit Data</div>
      <form autocomplete="off">
        <label>Symbol <input type="text" name="symbol" value="${atom.symbol || el[3]}" maxlength="3" required></label>
        <label>Full Name <input type="text" name="name" value="${atom.name || el[4]}" maxlength="20" required></label>
        <label>Proton <input type="number" name="proton" value="${atom.proton || el[2]}" min="1" max="999" required></label>
        <label>Electron <input type="number" name="electron" value="${atom.electron || el[2]}" min="1" max="999" required></label>
        <label>Neutron <input type="number" name="neutron" value="${atom.neutron || el[2]}" min="0" max="999" required></label>
        <div class="input-row">
          <label>Block Color</label>
          <input type="color" name="color" value="${atom.color || el[5] || "#23242d"}">
        </div>
        <button class="modal-submit-btn">Save</button>
        <div class="modal-error" style="display:none"></div>
      </form>
    </div>
  `;
  document.body.appendChild(modalBg);
  // Events
  modalBg.querySelector(".modal-close-btn").onclick = () => modalBg.remove();
  modalBg.onclick = (e) => { if (e.target === modalBg) modalBg.remove(); };
  const form = modalBg.querySelector("form");
  form.onsubmit = (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const data = {
      symbol: fd.get("symbol").trim(),
      name: fd.get("name").trim(),
      proton: Number(fd.get("proton")),
      electron: Number(fd.get("electron")),
      neutron: Number(fd.get("neutron")),
      color: fd.get("color")
    };
    // Validation
    if (!data.symbol || !data.name ||
        isNaN(data.proton) || isNaN(data.electron) || isNaN(data.neutron)) {
      showError("Fill all fields!");
      return;
    }
    db.ref("atoms/" + atomic).set(data).then(() => {
      modalBg.remove();
    }).catch(err => showError("Error: " + err.message));
  };
  function showError(msg) {
    const err = form.querySelector(".modal-error");
    err.textContent = msg;
    err.style.display = "block";
  }
}
// ------------------ ATOM SCREEN (3D) -------------------
function renderAtomScreen(slug) {
  // Find element
  const el = periodicTableLayout.find(e => e[4].toLowerCase() === slug);
  if (!el) {
    goToTable();
    return document.createElement("div");
  }
  const atom = atomsData[el[2]] || {};
  // Main
  const wrap = document.createElement("div");
  wrap.className = "atom-visual-wrap";
  // Toolbar
  const toolbar = document.createElement("div");
  toolbar.className = "atom-toolbar";
  toolbar.innerHTML = `
    <label>
      <input type="checkbox" id="nucleusViewChk">
      Hide orbits and show nucleus
    </label>
    <button class="about-btn" id="aboutBtn">About This Element</button>
  `;
  wrap.appendChild(toolbar);
  // Canvas
  const canvasWrap = document.createElement("div");
  canvasWrap.className = "atom-canvas-wrap";
  canvasWrap.innerHTML = `<canvas id="atom-canvas"></canvas>`;
  wrap.appendChild(canvasWrap);

  // Element meta
  wrap.innerHTML += `
    <div class="atom-element-name">${atom.name || el[4]} (${atom.symbol || el[3]})</div>
    <div class="atom-props-row">
      <div class="atom-prop">Proton: ${atom.proton || el[2]}</div>
      <div class="atom-prop">Electron: ${atom.electron || el[2]}</div>
      <div class="atom-prop">Neutron: ${atom.neutron || el[2]}</div>
    </div>
  `;
  // About modal
  toolbar.querySelector("#aboutBtn").onclick = () => openAboutModal(atom.name || el[4]);
  // Nucleus View
  let nucleusView = false;
  toolbar.querySelector("#nucleusViewChk").onchange = function() {
    nucleusView = this.checked;
    draw3DAtom();
  };

  // three.js atom drawing
  setTimeout(draw3DAtom, 100); // DOM ready
  function draw3DAtom() {
    const proton = atom.proton || el[2];
    const electron = atom.electron || el[2];
    const neutron = atom.neutron || el[2];
    const canvas = document.getElementById("atom-canvas");
    // Remove previous renderer
    while (canvas && canvas.parentNode && canvas.parentNode.firstChild)
      canvas.parentNode.removeChild(canvas.parentNode.firstChild);
    // Add a new canvas for three.js
    const c = document.createElement("canvas");
    c.id = "atom-canvas";
    c.width = canvasWrap.clientWidth || 700;
    c.height = canvasWrap.clientHeight || 400;
    canvasWrap.appendChild(c);

    // --- 3D Visualization ---
    // Renderer
    const renderer = new THREE.WebGLRenderer({canvas: c, antialias: true, alpha: false});
    renderer.setClearColor(0x151720);
    renderer.setSize(c.width, c.height);

    // Camera
    const camera = new THREE.PerspectiveCamera(45, c.width/c.height, 0.1, 1000);
    camera.position.set(0, 0, 14);

    // Scene
    const scene = new THREE.Scene();

    // Lighting
    const light = new THREE.PointLight(0xffffff, 1.2, 1000);
    light.position.set(20, 30, 50); scene.add(light);

    // Nucleus
    if (nucleusView) {
      // Show protons & neutrons as colored spheres
      // Arrange in a sphere
      const total = proton + neutron;
      const rad = 1.3;
      for (let i=0; i<proton; i++) {
        const phi = Math.acos(-1 + (2*i+1)/total);
        const theta = Math.PI * (1 + Math.sqrt(5)) * i;
        const x = rad * Math.cos(theta)*Math.sin(phi);
        const y = rad * Math.sin(theta)*Math.sin(phi);
        const z = rad * Math.cos(phi);
        const geom = new THREE.SphereGeometry(0.31, 24, 24);
        const mat = new THREE.MeshPhongMaterial({color: 0x00c3ff});
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.set(x, y, z);
        scene.add(mesh);
      }
      for (let i=0; i<neutron; i++) {
        const idx = i+proton;
        const phi = Math.acos(-1 + (2*idx+1)/total);
        const theta = Math.PI * (1 + Math.sqrt(5)) * idx;
        const x = rad * Math.cos(theta)*Math.sin(phi);
        const y = rad * Math.sin(theta)*Math.sin(phi);
        const z = rad * Math.cos(phi);
        const geom = new THREE.SphereGeometry(0.31, 24, 24);
        const mat = new THREE.MeshPhongMaterial({color: 0xb3b3b3});
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.set(x, y, z);
        scene.add(mesh);
      }
    } else {
      // Default: white large nucleus sphere
      const nucleusGeom = new THREE.SphereGeometry(1.35, 32, 32);
      const nucleusMat = new THREE.MeshPhongMaterial({color: 0xffffff});
      const nucleusMesh = new THREE.Mesh(nucleusGeom, nucleusMat);
      scene.add(nucleusMesh);

      // Electron Orbits (concentric circles, 2n^2 rules)
      const electronShells = [];
      let electronsLeft = electron;
      let n = 1;
      while (electronsLeft > 0 && n < 7) {
        const shellCap = Math.min(electronsLeft, 2*n*n);
        electronShells.push(shellCap);
        electronsLeft -= shellCap;
        n++;
      }
      // Draw orbits
      for (let i=0; i<electronShells.length; i++) {
        const orbitRad = 2.3 + i*1.1;
        const curve = new THREE.EllipseCurve(
          0, 0, orbitRad, orbitRad, 0, 2*Math.PI, false, 0
        );
        const pts = curve.getPoints(100);
        const geom = new THREE.BufferGeometry().setFromPoints(pts.map(p=>new THREE.Vector3(p.x, p.y, 0)));
        const mat = new THREE.LineBasicMaterial({color: 0x00e1ff, transparent:true, opacity:0.31});
        const ellipse = new THREE.LineLoop(geom, mat);
        scene.add(ellipse);
      }
      // Electrons (animated)
      // We'll animate them (simulate rotation) using requestAnimationFrame
      let animationFrame;
      function animateElectrons(time) {
        // Remove previous electrons
        for (let obj of scene.children.filter(o=>o.userData && o.userData.electron)) scene.remove(obj);
        let eCtr = 0;
        for (let i=0; i<electronShells.length; i++) {
          const nElectrons = electronShells[i];
          const orbitRad = 2.3 + i*1.1;
          for (let k=0; k<nElectrons; k++) {
            const ang = (k/nElectrons)*2*Math.PI + (time/1900)*(1+i*0.35);
            const ex = orbitRad * Math.cos(ang);
            const ey = orbitRad * Math.sin(ang);
            const geom = new THREE.SphereGeometry(0.22, 18, 18);
            const mat = new THREE.MeshPhongMaterial({color: 0xffffff});
            const mesh = new THREE.Mesh(geom, mat);
            mesh.position.set(ex, ey, 0);
            mesh.userData.electron = true;
            scene.add(mesh);
            eCtr++;
          }
        }
        renderer.render(scene, camera);
        animationFrame = requestAnimationFrame(animateElectrons);
      }
      animateElectrons(0);
      // On remove, cancel animation
      c.removeAnimation = () => cancelAnimationFrame(animationFrame);
      // If user toggles, remove animation
      toolbar.querySelector("#nucleusViewChk").onchange = function() {
        if (c.removeAnimation) c.removeAnimation();
        nucleusView = this.checked;
        draw3DAtom();
      };
      return; // Don't render again below, since animation already renders
    }
    renderer.render(scene, camera);
  }
  // Back to table on header click
  setTimeout(()=>{
    document.querySelector(".header-title").onclick = () => goToTable();
  }, 100);
  return wrap;
}
// ------------------ ABOUT MODAL ------------------------
function openAboutModal(elementName) {
  // Wikipedia embed
  const modalBg = document.createElement("div");
  modalBg.className = "about-modal-bg";
  modalBg.innerHTML = `
    <div class="about-modal">
      <button class="modal-close-btn">&times;</button>
      <div class="about-modal-title">About ${elementName}</div>
      <iframe class="about-modal-iframe"
        src="https://en.wikipedia.org/wiki/${encodeURIComponent(elementName)}"
        loading="lazy"></iframe>
    </div>
  `;
  document.body.appendChild(modalBg);
  modalBg.querySelector(".modal-close-btn").onclick = () => modalBg.remove();
  modalBg.onclick = (e) => { if (e.target === modalBg) modalBg.remove(); };
}

// ----------------- INITIAL RENDER ----------------------
renderApp();
  </script>
</body>
  </html>
