<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Periodic Table</title>
  <style>
    :root{
      --bg:#06060a;
      --panel:#0f1116;
      --card:#101219;
      --muted:#9aa4b2;
      --text:#e8ecf1;
      --ring:#212432;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial;color:var(--text);background:
      radial-gradient(900px 500px at 80% -10%, #0b0c12, var(--bg));}
    #app{position:relative; width:100%; height:100%; overflow:hidden}

    /* Views */
    .view{position:absolute; inset:0; display:none}
    .view.active{display:block}

    /* Sign-in */
    .signin{display:grid; place-items:center; padding:20px}
    .signin-card{width:min(640px,94vw); background:linear-gradient(180deg,#0c0d13,#0a0b11); border-radius:18px; padding:28px; border:1px solid var(--ring); box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .brand{font-size:28px; font-weight:800; margin-bottom:6px}
    .subtitle{color:var(--muted); margin-bottom:18px}
    .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;background:linear-gradient(180deg,#182033,#0f1624);color:var(--text);cursor:pointer;font-weight:700}
    .btn-google{display:inline-flex;align-items:center;gap:10px;padding:12px 18px}
    .tiny{font-size:13px;color:var(--muted);margin-top:10px}

    /* Topbar */
    .topbar{position:fixed;left:0;right:0;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:rgba(6,7,10,.6);backdrop-filter:blur(6px);border-bottom:1px solid var(--ring);z-index:40}
    .topbar .title{font-weight:800}
    .userbadge{display:flex;align-items:center;gap:10px;color:var(--muted)}
    .avatar{width:36px;height:36px;border-radius:10px;background:#0d1116;overflow:hidden}

    /* Table */
    .table-wrap{position:absolute;inset:56px 0 0 0;overflow:auto;padding:18px}
    .legend{color:var(--muted);font-size:13px;margin-bottom:10px}
    .grid{--cols:18;display:grid;grid-template-columns:repeat(var(--cols), minmax(40px,1fr));gap:10px;width:min(1400px,96vw);margin:0 auto}
    .cell{position:relative;min-height:68px;padding:8px;border-radius:12px;background:var(--card);border:1px solid var(--ring);display:grid;grid-template-rows:auto 1fr;cursor:pointer;overflow:hidden}
    .cell.empty{background:transparent;border-color:transparent;pointer-events:none}
    .cell .meta{display:flex;justify-content:flex-end;gap:8px;color:var(--muted);font-size:12px}
    .cell .symbol{justify-self:center;align-self:center;font-weight:800;font-size:18px;letter-spacing:.3px}
    .cell .name{justify-self:center;font-size:12px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}

    /* f-block */
    .fblock-row{margin-top:12px}

    /* Atom view */
    .atom-wrap{position:absolute;inset:56px 0 0 0;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
    .toolbar{display:flex;align-items:center;gap:16px;padding:12px 18px;border-bottom:1px solid var(--ring);background:rgba(6,7,10,.6);backdrop-filter:blur(6px)}
    .toolbar .check{display:flex;align-items:center;gap:8px}
    #rendererHost{position:relative;width:100%;height:100%;overflow:hidden}
    .aboutbar{display:flex;justify-content:center;padding:12px}

    /* Bottom sheet */
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--panel);border-top-left-radius:14px;border-top-right-radius:14px;box-shadow:0 -20px 60px rgba(0,0,0,.6);z-index:60;transition:bottom .28s ease}
    .sheet.open{bottom:0}
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring)}
    .sheet-body{height:min(68vh,560px);padding:0;overflow:hidden}

    /* Owner modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:70}
    .modal-backdrop.open{display:flex}
    .modal{width:min(720px,96vw);background:linear-gradient(180deg,#0b0c11,#0d0f14);border-radius:12px;padding:14px;border:1px solid var(--ring)}
    .form{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .input,.color{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:#0b0d12;color:var(--text)}

    /* responsive */
    @media (max-width:720px){
      .grid{grid-template-columns:repeat(10, minmax(36px,1fr));gap:8px}
      .cell{min-height:56px}
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sign In View -->
    <section id="view-signin" class="view signin active">
      <div class="signin-card" role="dialog" aria-labelledby="signin-title">
        <div id="signin-title" class="brand">3D Periodic Table</div>
        <div class="subtitle">Sign in with Google to explore interactive 3D atoms</div>
        <button id="btn-google" class="btn btn-google" aria-label="Sign in with Google">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.9 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C33.9 6.1 29.2 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.7-.4-3.9z"/></svg>
          Sign in with Google
        </button>
        <div class="tiny">Sign in is required to view and interact with the periodic table.</div>
      </div>
    </section>

    <!-- Table View -->
    <section id="view-table" class="view" aria-hidden="true">
      <div class="topbar">
        <div class="title">3D Periodic Table</div>
        <div class="userbadge">
          <div id="userEmail" class="email">…</div>
          <div class="avatar"><img id="userPhoto" alt="" style="width:100%;height:100%;object-fit:cover;display:none" /></div>
          <button id="btn-logout" class="btn" title="Sign out">Logout</button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="legend">এক্সপ্লোর: single-click → atom view • owner double-click → edit modal</div>
        <div id="grid-main" class="grid" aria-label="Periodic Table Grid"></div>
        <div class="fblock-row">
          <div id="grid-f" class="grid" style="--cols:15"></div>
        </div>
        <div class="fblock-row">
          <div id="grid-f2" class="grid" style="--cols:15"></div>
        </div>
      </div>
    </section>

    <!-- Atom View -->
    <section id="view-atom" class="view" aria-hidden="true">
      <div class="topbar">
        <div class="title"><span id="atomTitle">Element</span></div>
        <div class="userbadge">
          <button id="btn-back" class="btn">← Table</button>
          <button id="btn-about-atom" class="btn">About</button>
          <button id="btn-logout2" class="btn">Logout</button>
        </div>
      </div>

      <div class="atom-wrap">
        <div class="toolbar">
          <label class="check"><input type="checkbox" id="toggleNucleus" /> Hide orbits and show nucleus</label>
          <div style="color:var(--muted);font-size:13px">Proton = green • Neutron = orange • Electron = light</div>
        </div>

        <div id="rendererHost" role="region" aria-label="3D atom view"></div>

        <div class="aboutbar">
          <button id="btn-about" class="btn">About</button>
        </div>
      </div>
    </section>

    <!-- About sheet -->
    <div id="aboutSheet" class="sheet" aria-hidden="true">
      <div class="sheet-header">
        <div id="aboutTitle">About</div>
        <button id="aboutClose" class="btn">Close</button>
      </div>
      <div class="sheet-body">
        <iframe id="aboutFrame" src="about:blank" referrerpolicy="no-referrer" style="width:100%;height:100%;border:0;background:#07070b"></iframe>
      </div>
    </div>

    <!-- Owner Edit Modal (double-click opens for owner) -->
    <div id="ownerModal" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 id="modalTitle">Edit Element</h3>
        <div class="form">
          <div>
            <div class="label">Atom short-name (সংকেত)</div>
            <input id="inSymbol" class="input" placeholder="H" maxlength="3" />
          </div>
          <div>
            <div class="label">Atom full name</div>
            <input id="inName" class="input" placeholder="Hydrogen" />
          </div>
          <div class="row">
            <div>
              <div class="label">Proton number</div>
              <input id="inProtons" class="input" type="number" min="0" />
            </div>
            <div>
              <div class="label">Electron number</div>
              <input id="inElectrons" class="input" type="number" min="0" />
            </div>
          </div>
          <div>
            <div class="label">Neutron number</div>
            <input id="inNeutrons" class="input" type="number" min="0" />
          </div>
          <div>
            <div class="label">Block color</div>
            <input id="inColor" class="color" type="color" value="#1a1e2f" />
          </div>
          <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px">
            <button id="btn-cancel" class="btn">Cancel</button>
            <button id="btn-save" class="btn" style="background:linear-gradient(180deg,#0e734f,#0b5a3e);border-color:#137a57">Submit</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- three.js local file (must be in same directory) -->
  <script src="./three.js"></script>

  <script>
    // ====== CONFIG ======
    const OWNER_EMAIL = 'samiulhaquerafsan@gmail.com';
    const firebaseConfig = {
      apiKey: "AIzaSyCMEqtaxOodPnwMKkrSVZrcjLMmj3oefB0",
  authDomain: "chatstudio-agent.firebaseapp.com",
  databaseURL: "https://chatstudio-agent-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatstudio-agent",
  storageBucket: "chatstudio-agent.firebasestorage.app",
  messagingSenderId: "626338448826",
  appId: "1:626338448826:web:67936971701c3466d90983",
  measurementId: "G-ZHNZHMYC0B"
    };

    // ====== INIT FIREBASE ======
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ====== STATE ======
    let currentUser = null;
    let elementsCache = {}; // elements data keyed by atomic number
    let currentAtomic = null; // for owner modal

    // ====== ROUTER HELPERS ======
    function show(viewId){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      const v = document.getElementById(viewId);
      if(v) v.classList.add('active');
    }
    function routeTo(path){
      try{ history.pushState({}, '', path); }catch(e){}
      window.location.hash = '#'+path;
      handleRoute();
    }
    function getPath(){
      if(location.hash && location.hash.startsWith('#')) return location.hash.slice(1);
      return location.pathname && location.pathname !== '/' ? location.pathname : '/';
    }
    window.addEventListener('popstate', handleRoute);
    window.addEventListener('hashchange', handleRoute);

    function handleRoute(){
      if(!currentUser){ show('view-signin'); return; }
      const p = getPath().replace(/^\/+|\/+$/g,'');
      if(!p || p === 'table' || p === ''){ show('view-table'); return; }
      openAtomBySlug(p);
    }

    // ====== AUTH ======
    document.getElementById('btn-google').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{ await auth.signInWithPopup(provider); } catch(err){ alert('Sign-in failed: '+err.message); }
    });
    document.getElementById('btn-logout').addEventListener('click', ()=> auth.signOut());
    document.getElementById('btn-logout2').addEventListener('click', ()=> auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      if(!user){ show('view-signin'); return; }
      // set user info
      const emailEl = document.getElementById('userEmail');
      const photoEl = document.getElementById('userPhoto');
      emailEl.textContent = user.email || 'Signed in';
      if(user.photoURL){ photoEl.src = user.photoURL; photoEl.style.display='block'; }
      // attach DB listeners
      attachDBListeners();
      // go to table
      routeTo('/table');
    });

    // ====== DB ======
    let dbAttached = false;
    function attachDBListeners(){
      if(dbAttached) return; dbAttached=true;
      db.ref('elements').on('value', snap=>{
        elementsCache = snap.val() || {};
        renderTable();
        // refresh current atom if open
        const p = getPath().replace(/^\/+|\/+$/g,'');
        if(p && p !== 'table' && p !== '') openAtomBySlug(p, true);
      });
    }

    // ====== PERIODIC TABLE LAYOUT ======
    const mainLayout = [
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
      [3,4,0,0,0,0,0,0,0,0,0,0,5,6,7,8,9,10],
      [11,12,0,0,0,0,0,0,0,0,0,0,13,14,15,16,17,18],
      [19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36],
      [37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54],
      [55,56,0,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86],
      [87,88,0,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118],
    ];
    const fBlock1 = [57,58,59,60,61,62,63,64,65,66,67,68,69,70,71];
    const fBlock2 = [89,90,91,92,93,94,95,96,97,98,99,100,101,102,103];

    const gridMain = document.getElementById('grid-main');
    const gridF = document.getElementById('grid-f');
    const gridF2 = document.getElementById('grid-f2');

    function renderTable(){
      gridMain.innerHTML = '';
      mainLayout.forEach(row=>{
        row.forEach(num=>{
          if(num===0){
            const div=document.createElement('div'); div.className='cell empty'; gridMain.appendChild(div); return;
          }
          const data = elementsCache[num] || {};
          const cell = document.createElement('div'); cell.className='cell'; cell.dataset.num=num;
          if(data.color) cell.style.background = data.color;
          // meta
          const meta = document.createElement('div'); meta.className='meta';
          const numEl = document.createElement('div'); numEl.className='num'; numEl.textContent = num;
          const symEl = document.createElement('div'); symEl.className='sym'; symEl.textContent = data.shortName||'';
          meta.append(numEl, symEl);
          const symbol = document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName? data.shortName : num;
          const name = document.createElement('div'); name.className='name'; name.textContent = data.name||'';
          cell.append(meta, symbol, name);
          cell.addEventListener('click', ()=> onCellClick(num));
          cell.addEventListener('dblclick', (e)=> onCellDblClick(e, num));
          gridMain.appendChild(cell);
        });
      });

      // f block row 1
      gridF.innerHTML=''; const label1=document.createElement('div'); label1.className='cell empty'; label1.style.background='transparent'; label1.style.border='0'; label1.textContent='Lanthanides'; gridF.appendChild(label1);
      fBlock1.forEach(num=>{ const data=elementsCache[num]||{}; const cell=document.createElement('div'); cell.className='cell'; if(data.color) cell.style.background=data.color; cell.dataset.num=num; const meta=document.createElement('div'); meta.className='meta'; const numEl=document.createElement('div'); numEl.className='num'; numEl.textContent=num; const symEl=document.createElement('div'); symEl.className='sym'; symEl.textContent=data.shortName||''; meta.append(numEl,symEl); const symbol=document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName?data.shortName:num; const name=document.createElement('div'); name.className='name'; name.textContent=data.name||''; cell.append(meta,symbol,name); cell.addEventListener('click', ()=> onCellClick(num)); cell.addEventListener('dblclick', (e)=> onCellDblClick(e,num)); gridF.appendChild(cell); });

      // f block row 2
      gridF2.innerHTML=''; const label2=document.createElement('div'); label2.className='cell empty'; label2.style.background='transparent'; label2.style.border='0'; label2.textContent='Actinides'; gridF2.appendChild(label2);
      fBlock2.forEach(num=>{ const data=elementsCache[num]||{}; const cell=document.createElement('div'); cell.className='cell'; if(data.color) cell.style.background=data.color; cell.dataset.num=num; const meta=document.createElement('div'); meta.className='meta'; const numEl=document.createElement('div'); numEl.className='num'; numEl.textContent=num; const symEl=document.createElement('div'); symEl.className='sym'; symEl.textContent=data.shortName||''; meta.append(numEl,symEl); const symbol=document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName?data.shortName:num; const name=document.createElement('div'); name.className='name'; name.textContent=data.name||''; cell.append(meta,symbol,name); cell.addEventListener('click', ()=> onCellClick(num)); cell.addEventListener('dblclick', (e)=> onCellDblClick(e,num)); gridF2.appendChild(cell); });
    }

    function onCellClick(num){
      const data = elementsCache[num];
      let slug = data && data.slug ? data.slug : ('element-'+num);
      routeTo('/'+slug);
    }

    function onCellDblClick(e, num){
      if(!currentUser) return;
      if(currentUser.email !== OWNER_EMAIL) return; // only owner
      openOwnerModal(num);
    }

    // ====== OWNER MODAL ======
    const backdrop = document.getElementById('ownerModal');
    const inSymbol = document.getElementById('inSymbol');
    const inName = document.getElementById('inName');
    const inProtons = document.getElementById('inProtons');
    const inElectrons = document.getElementById('inElectrons');
    const inNeutrons = document.getElementById('inNeutrons');
    const inColor = document.getElementById('inColor');
    document.getElementById('btn-cancel').addEventListener('click', ()=> backdrop.classList.remove('open'));
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.classList.remove('open')});

    document.getElementById('btn-save').addEventListener('click', async ()=>{
      if(currentAtomic==null) return;
      const num = currentAtomic;
      const symbol = (inSymbol.value||'').trim();
      const name = (inName.value||'').trim();
      const protons = Math.max(0, parseInt(inProtons.value||'0'));
      const electrons = Math.max(0, parseInt(inElectrons.value||'0'));
      const neutrons = Math.max(0, parseInt(inNeutrons.value||'0'));
      const color = inColor.value || '#1a1e2f';
      const slug = (name? name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'') : ('element-'+num));
      const payload = { shortName: symbol, name, protons, electrons, neutrons, color, slug };
      try{
        await db.ref('elements/'+num).update(payload);
        backdrop.classList.remove('open');
      }catch(err){
        alert('Save failed: '+ err.message);
      }
    });

    function openOwnerModal(num){
      currentAtomic = num;
      const data = elementsCache[num] || {};
      document.getElementById('modalTitle').textContent = `Edit Element #${num}`;
      inSymbol.value = data.shortName||'';
      inName.value = data.name||'';
      inProtons.value = data.protons!=null? data.protons : '';
      inElectrons.value = data.electrons!=null? data.electrons : '';
      inNeutrons.value = data.neutrons!=null? data.neutrons : '';
      inColor.value = data.color||'#1a1e2f';
      backdrop.classList.add('open');
    }

    // ====== THREE.JS ATOM VIEW ======
    let renderer, scene, camera, controls;
    let nucleusSolid, nucleusGroup = null, orbitGroups = [], electronGroups = [];
    let animId = null;
    const host = document.getElementById('rendererHost');
    const toggleNucleus = document.getElementById('toggleNucleus');
    const atomTitle = document.getElementById('atomTitle');
    const aboutBtn = document.getElementById('btn-about');
    const aboutSheet = document.getElementById('aboutSheet');
    const aboutFrame = document.getElementById('aboutFrame');
    const aboutTitle = document.getElementById('aboutTitle');
    const aboutClose = document.getElementById('aboutClose');
    document.getElementById('btn-back').addEventListener('click', ()=> routeTo('/table'));
    document.getElementById('btn-about-atom').addEventListener('click', ()=> aboutSheet.classList.add('open'));
    aboutClose.addEventListener('click', ()=> aboutSheet.classList.remove('open'));
    aboutBtn.addEventListener('click', ()=> aboutSheet.classList.add('open'));

    function resetThree(){
      if(animId) cancelAnimationFrame(animId);
      if(renderer){ try{ renderer.forceContextLoss(); renderer.domElement.parentNode.removeChild(renderer.domElement);}catch(e){} renderer=null; }
      orbitGroups = []; electronGroups = []; nucleusGroup=null; nucleusSolid=null;
      renderer = new THREE.WebGLRenderer({antialias:true, alpha:false});
      renderer.setPixelRatio(window.devicePixelRatio||1);
      renderer.setSize(host.clientWidth, host.clientHeight);
      host.innerHTML=''; host.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x07080e);

      const fov=45, aspect=host.clientWidth/host.clientHeight, near=0.1, far=1000;
      camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
      camera.position.set(0,1.2,6);

      const light = new THREE.PointLight(0xffffff,1.1,100); light.position.set(10,10,10); scene.add(light);
      const amb = new THREE.AmbientLight(0x666666); scene.add(amb);

      // Lightweight orbit control fallback
      let isDown=false, lx=0, ly=0, rx=0, ry=0;
      renderer.domElement.addEventListener('pointerdown', e=>{ isDown=true; lx=e.clientX; ly=e.clientY; renderer.domElement.setPointerCapture(e.pointerId); });
      window.addEventListener('pointerup', ()=>{ isDown=false; });
      window.addEventListener('pointermove', e=>{ if(!isDown) return; rx += (e.clientX-lx)*0.003; ry += (e.clientY-ly)*0.003; lx=e.clientX; ly=e.clientY; camera.position.x = 6*Math.sin(rx); camera.position.z = 6*Math.cos(rx); camera.position.y = Math.max(0.6, Math.min(3, camera.position.y - (e.movementY*0.01))); camera.lookAt(0,0,0); });
      renderer.domElement.addEventListener('wheel', e=>{ const s = 1 + (e.deltaY>0?0.04:-0.04); camera.position.multiplyScalar(s); camera.lookAt(0,0,0); });

      window.addEventListener('resize', ()=>{ if(!renderer) return; renderer.setSize(host.clientWidth, host.clientHeight); camera.aspect = host.clientWidth/host.clientHeight; camera.updateProjectionMatrix(); });
    }

    function buildAtomView(data){
      resetThree();

      // nucleus solid
      const nucleusGeom = new THREE.SphereGeometry(0.6, 48, 48);
      const nucleusMat = new THREE.MeshPhongMaterial({color:0xffffff, shininess:80, emissive:0x000000, transparent:true, opacity:0.95});
      nucleusSolid = new THREE.Mesh(nucleusGeom, nucleusMat);
      scene.add(nucleusSolid);

      // inner nucleons
      nucleusGroup = new THREE.Group();
      const pCount = Math.max(0, parseInt(data.protons||0));
      const nCount = Math.max(0, parseInt(data.neutrons||0));
      const pGeom = new THREE.SphereGeometry(0.08, 12, 12);
      const pMat = new THREE.MeshStandardMaterial({color:0x10B981});
      const nGeom = new THREE.SphereGeometry(0.08, 12, 12);
      const nMat = new THREE.MeshStandardMaterial({color:0xF59E0B});
      const innerR = 0.45;
      for(let i=0;i<pCount;i++){ const m=new THREE.Mesh(pGeom,pMat); const v=randomPointInSphere(innerR); m.position.set(v.x,v.y,v.z); nucleusGroup.add(m); }
      for(let i=0;i<nCount;i++){ const m=new THREE.Mesh(nGeom,nMat); const v=randomPointInSphere(innerR); m.position.set(v.x,v.y,v.z); nucleusGroup.add(m); }
      nucleusGroup.visible = false;
      scene.add(nucleusGroup);

      // electrons and orbits
      const eTotal = Math.max(0, parseInt(data.electrons||0));
      const shells = distributeElectrons(eTotal);
      const orbitMat = new THREE.LineBasicMaterial({color:0x9aa4b2, linewidth:1});
      shells.forEach((count, idx)=>{
        const n = idx+1;
        const radius = 1.0 + (n * 0.6);
        const circleGeom = circleGeometry(radius, 128);
        const ring = new THREE.LineLoop(circleGeom, orbitMat);
        scene.add(ring); orbitGroups.push(ring);
        const group = new THREE.Group();
        for(let i=0;i<count;i++){
          const angle = (i/count) * Math.PI*2;
          const eGeom = new THREE.SphereGeometry(0.07, 12, 12);
          const eMat = new THREE.MeshStandardMaterial({color:0xE8ECF1});
          const eMesh = new THREE.Mesh(eGeom, eMat);
          eMesh.userData = { angle, radius, speed: 0.35/(n + 0.5) };
          eMesh.position.set(Math.cos(angle)*radius, 0, Math.sin(angle)*radius);
          group.add(eMesh);
        }
        electronGroups.push(group);
        scene.add(group);
      });

      toggleNucleus.checked = false; applyToggle();
      animate();
    }

    function animate(){
      animId = requestAnimationFrame(animate);
      electronGroups.forEach(group=>{
        group.children.forEach(e=>{
          const ud = e.userData; if(!ud) return;
          ud.angle += ud.speed * 0.02;
          e.position.set(Math.cos(ud.angle)*ud.radius, 0, Math.sin(ud.angle)*ud.radius);
        });
      });
      if(renderer && scene && camera) renderer.render(scene, camera);
    }

    function applyToggle(){
      const showInner = toggleNucleus.checked;
      orbitGroups.forEach(o=> o.visible = !showInner);
      electronGroups.forEach(g=> g.visible = !showInner);
      nucleusGroup.visible = showInner;
      nucleusSolid.visible = !showInner;
    }
    toggleNucleus.addEventListener('change', applyToggle);

    function randomPointInSphere(r){
      let x,y,z;
      do{ x=(Math.random()*2-1); y=(Math.random()*2-1); z=(Math.random()*2-1); } while(x*x+y*y+z*z>1);
      return new THREE.Vector3(x*r,y*r,z*r);
    }
    function circleGeometry(radius, segments){
      const geom = new THREE.BufferGeometry();
      const pts = [];
      for(let i=0;i<segments;i++){ const a=(i/segments)*Math.PI*2; pts.push(radius*Math.cos(a),0,radius*Math.sin(a)); }
      geom.setAttribute('position', new THREE.Float32BufferAttribute(pts,3));
      return geom;
    }
    function distributeElectrons(total){
      const shells = []; let n=1, remaining=total;
      while(remaining>0 && shells.length<7){
        const cap = 2*n*n;
        const take = Math.min(cap, remaining);
        shells.push(take);
        remaining -= take; n++;
      }
      return shells;
    }

    // ====== OPEN ATOM BY SLUG ======
    async function openAtomBySlug(slug, fromRefresh){
      // find by slug or element-<num> or name
      let foundNum = null, data=null;
      for(const [numStr,v] of Object.entries(elementsCache)){ if(v && v.slug === slug){ foundNum = parseInt(numStr); data = v; break; } }
      if(!foundNum){
        const m = slug.match(/^element-(\d{1,3})$/);
        if(m){ foundNum = parseInt(m[1]); data = elementsCache[foundNum] || {protons:foundNum, electrons:foundNum, neutrons:0, name:'Element '+foundNum, shortName:''}; }
      }
      if(!foundNum){
        for(const [numStr,v] of Object.entries(elementsCache)){ if(v && v.name && v.name.toLowerCase() === slug){ foundNum = parseInt(numStr); data=v; break; } }
      }
      if(!foundNum){ routeTo('/table'); return; }

      document.getElementById('aboutTitle').textContent = (data.name || ('Element '+foundNum));
      document.getElementById('aboutFrame').src = data.name ? ('https://en.wikipedia.org/wiki/'+ encodeURIComponent(data.name)) : 'about:blank';
      atomTitle.textContent = data.name || ('Element '+foundNum);
      show('view-atom');

      buildAtomView({
        protons: data.protons ?? foundNum,
        neutrons: data.neutrons ?? 0,
        electrons: data.electrons ?? foundNum
      });
    }

    // ====== ABOUT & OWNER DOUBLECLICK BEHAVIOR (ESC/CLOSERS) ======
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.getElementById('aboutSheet').classList.remove('open'); document.getElementById('ownerModal').classList.remove('open'); }});
    document.getElementById('aboutClose').addEventListener('click', ()=> document.getElementById('aboutSheet').classList.remove('open'));

    // ====== INITIAL TABLE RENDER & Router ======
    renderTable();
    handleRoute();
  </script>
</body>
  </html>
