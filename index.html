<!DOCTYPE html><html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Periodic Table</title>
  <style>
    :root{
      --bg:#0b0b0f; /* deep dark */
      --bg-elev:#111219;
      --panel:#151826;
      --text:#E8ECF1;
      --muted:#9AA4B2;
      --accent:#6EE7F0;
      --good:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;
      --card:#0f1220;
      --ring:#2a2f45;
      --block:#1a1e2f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #12142a, var(--bg));
      color:var(--text);
      overflow:hidden; /* we'll manage scroll in inner views */
    }
    a{color:inherit;text-decoration:none}/* Root app container */
#app{position:relative; width:100%; height:100%; display:grid; place-items:center}

/* Views */
.view{position:absolute; inset:0; display:none}
.view.active{display:block}

/* Sign-in screen */
.signin{
  display:grid; place-items:center; padding:24px;
}
.signin-card{
  background:linear-gradient(180deg, var(--panel), #0d0f18);
  border:1px solid var(--ring);
  box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.04);
  border-radius:20px; padding:28px; width:min(460px, 92vw);
  text-align:center;
}
.brand{font-size:28px; font-weight:800; letter-spacing:0.3px; margin-bottom:6px}
.subtitle{color:var(--muted); margin-bottom:20px}
.btn{
  appearance:none; border:0; padding:14px 18px; border-radius:14px; font-weight:700; font-size:16px;
  background:linear-gradient(180deg, #1b243b, #111626);
  color:var(--text); cursor:pointer; border:1px solid var(--ring);
  transition:transform .08s ease, box-shadow .2s ease;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn.google{display:flex; align-items:center; justify-content:center; gap:10px}
.tiny{font-size:12px; color:var(--muted); margin-top:14px}

/* Top bar */
.topbar{position:fixed; top:0; left:0; right:0; height:56px; display:flex; align-items:center; justify-content:space-between;
  padding:0 14px; background: rgba(10,12,20,0.6); backdrop-filter: blur(8px); border-bottom:1px solid var(--ring); z-index:40}
.topbar .title{font-weight:800; letter-spacing:.3px}
.userbadge{display:flex; align-items:center; gap:10px; color:var(--muted)}
.avatar{width:28px; height:28px; border-radius:50%; background:#2b2f43; overflow:hidden}
.logout{margin-left:8px}

/* Table view */
.table-wrap{position:absolute; inset:56px 0 0 0; overflow:auto; padding:16px}
.legend{display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px; margin:6px 2px 12px}
.grid{--cols:18; display:grid; grid-template-columns:repeat(var(--cols), minmax(38px, 1fr)); gap:8px;
  width:min(1400px, 96vw); margin:0 auto}
.row-spacer{height:8px}

.cell{
  position:relative; min-height:58px; padding:6px 6px 8px; border-radius:12px; background:var(--block);
  border:1px solid var(--ring); display:grid; grid-template-rows:auto 1fr; cursor:pointer;
  transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease; 
  user-select:none;
}
.cell:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.35)}
.cell .meta{display:flex; align-items:center; justify-content:flex-end; gap:6px; color:var(--muted); font-size:10px}
.cell .meta .num{font-variant-numeric: tabular-nums}
.cell .symbol{justify-self:center; align-self:center; font-weight:900; font-size:16px; letter-spacing:.2px}
.cell .name{justify-self:center; font-size:11px; color:var(--muted); margin-top:4px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%}
.cell.empty{background:transparent; border-color:transparent; box-shadow:none; cursor:default}
.cell.fblock-label{background:transparent; border-color:transparent; color:var(--muted); display:flex; align-items:center; justify-content:flex-start; padding-left:4px; font-size:12px}

/* Atom view */
.atom-wrap{position:absolute; inset:56px 0 0 0; display:grid; grid-template-rows:auto 1fr auto; overflow:hidden}
.toolbar{display:flex; align-items:center; gap:16px; padding:10px 14px; border-bottom:1px solid var(--ring); background: rgba(10,12,20,0.6); backdrop-filter: blur(8px)}
.toolbar .check{display:flex; align-items:center; gap:8px; font-size:14px}
#rendererHost{position:relative; width:100%; height:100%; overflow:hidden}
.aboutbar{display:flex; justify-content:center; padding:10px}

/* Bottom sheet modal */
.sheet{position:fixed; left:0; right:0; bottom:-100%; background:var(--panel); border-top:1px solid var(--ring); border-radius:16px 16px 0 0; box-shadow:0 -20px 60px rgba(0,0,0,.6); z-index:60; transition:bottom .28s ease}
.sheet.open{bottom:0}
.sheet-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--ring)}
.sheet-body{height:min(70vh, 560px); padding:0; overflow:hidden}
.sheet-body iframe{width:100%; height:100%; border:0; background:#0b0c15}

/* Owner edit modal */
.modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:70}
.modal-backdrop.open{display:flex}
.modal{width:min(640px, 96vw); background:var(--panel); border:1px solid var(--ring); border-radius:16px; padding:16px}
.modal h3{margin:4px 0 10px}
.form{display:grid; gap:10px}
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.label{font-size:12px; color:var(--muted); margin-bottom:4px}
.input, .color{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:#0e1120; color:var(--text)}
.actions{display:flex; justify-content:flex-end; gap:10px; margin-top:8px}

/* Responsive tweaks */
@media (max-width:640px){
  .grid{grid-template-columns:repeat(var(--cols), minmax(34px, 1fr)); gap:6px}
  .cell{min-height:52px}
  .cell .symbol{font-size:14px}
}

  </style>
</head>
<body>
<div id="app">
  <!-- Sign In View -->
  <section id="view-signin" class="view signin active">
    <div class="signin-card">
      <div class="brand">3D Periodic Table</div>
      <div class="subtitle">Explore elements with interactive 3D atoms — dark, fast, and educational.</div>
      <button id="btn-google" class="btn google" title="Sign in with Google">
        <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.9 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C33.9 6.1 29.2 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.7-.4-3.9z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16.6 18.9 14 24 14c3.1 0 5.9 1.2 8 3.1l5.7-5.7C33.9 6.1 29.2 4 24 4c-7.7 0-14.3 4.3-17.7 10.7z"/><path fill="#4CAF50" d="M24 44c5.1 0 9.8-1.9 13.3-5.1l-6.1-5.1C29.1 35.5 26.7 36 24 36c-5.1 0-9.4-3.1-11.2-7.5l-6.5 5C9.7 40 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.1 3.4-4.5 6-8.3 6-5.1 0-9.4-3.1-11.2-7.5l-6.5 5C9.7 40 16.3 44 24 44c11.1 0 20-8.9 20-20 0-1.3-.1-2.7-.4-3.9z"/></svg>
        Sign in with Google
      </button>
      <div class="tiny">Sign in required to view the table.</div>
    </div>
  </section>  <!-- Table View -->  <section id="view-table" class="view">
    <div class="topbar">
      <div class="title">3D Periodic Table</div>
      <div class="userbadge">
        <div id="userEmail" class="email">…</div>
        <div class="avatar"><img id="userPhoto" alt="" style="width:100%;height:100%;object-fit:cover;display:none"/></div>
        <button id="btn-logout" class="btn logout">Logout</button>
      </div>
    </div>
    <div class="table-wrap">
      <div class="legend">Tap once to open atom • Double-click to edit (owner only)</div>
      <div id="grid-main" class="grid"></div>
      <div class="row-spacer"></div>
      <div id="grid-f" class="grid" style="--cols:15"></div>
      <div class="row-spacer"></div>
      <div id="grid-f2" class="grid" style="--cols:15"></div>
    </div>
  </section>  <!-- Atom View -->  <section id="view-atom" class="view">
    <div class="topbar">
      <div class="title"><span id="atomTitle">Element</span></div>
      <div class="userbadge">
        <button id="btn-back" class="btn">← Table</button>
        <button id="btn-logout2" class="btn logout">Logout</button>
      </div>
    </div>
    <div class="atom-wrap">
      <div class="toolbar">
        <label class="check"><input type="checkbox" id="toggleNucleus"/> Hide orbits and show nucleus</label>
        <div class="tiny">Proton = green • Neutron = orange • Electron = default</div>
      </div>
      <div id="rendererHost"></div>
      <div class="aboutbar">
        <button id="btn-about" class="btn">About</button>
      </div>
    </div>
  </section>  <!-- About bottom sheet -->  <div id="aboutSheet" class="sheet">
    <div class="sheet-header">
      <div id="aboutTitle">About</div>
      <button id="aboutClose" class="btn">Close</button>
    </div>
    <div class="sheet-body">
      <iframe id="aboutFrame" src="about:blank" referrerpolicy="no-referrer"></iframe>
    </div>
  </div>  <!-- Owner Edit Modal -->  <div id="ownerModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">Edit Element</h3>
      <div class="form">
        <div>
          <div class="label">Atom short-name (symbol)</div>
          <input id="inSymbol" class="input" placeholder="H" maxlength="3" />
        </div>
        <div>
          <div class="label">Atom full name</div>
          <input id="inName" class="input" placeholder="Hydrogen" />
        </div>
        <div class="row">
          <div>
            <div class="label">Proton number</div>
            <input id="inProtons" class="input" type="number" min="0" />
          </div>
          <div>
            <div class="label">Electron number</div>
            <input id="inElectrons" class="input" type="number" min="0" />
          </div>
        </div>
        <div>
          <div class="label">Neutron number</div>
          <input id="inNeutrons" class="input" type="number" min="0" />
        </div>
        <div>
          <div class="label">Block color</div>
          <input id="inColor" class="color" type="color" value="#1a1e2f" />
        </div>
        <div class="actions">
          <button id="btn-cancel" class="btn">Cancel</button>
          <button id="btn-save" class="btn" style="background:linear-gradient(180deg,#0e734f,#0b5a3e); border-color:#137a57">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div><!-- Firebase SDKs (Compat for simplicity) --><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script><!-- three.js (local file in same directory) --><script src="./three.js"></script><script>
  // ====== CONFIG ======
  const OWNER_EMAIL = 'owner@gmail.com';
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };

  // ====== INIT FIREBASE ======
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ====== STATE ======
  let currentUser = null;
  let elementsCache = {}; // { [atomicNumber]: {name, shortName, protons, electrons, neutrons, color, slug} }
  let currentAtomic = null; // for modal

  // ====== SIMPLE ROUTER ======
  function show(viewId){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
  }

  function routeTo(path){
    // Use history API but also set hash fallback for static hosting
    try{ history.pushState({}, '', path); }
    catch(e){}
    window.location.hash = '#' + path; // fallback
    handleRoute();
  }

  function getPath(){
    // prefer history path, fallback to hash
    const p = location.pathname && location.pathname !== '/' ? location.pathname : null;
    if(p) return p;
    if(location.hash.startsWith('#')) return location.hash.slice(1);
    return '/';
  }

  window.addEventListener('popstate', handleRoute);
  window.addEventListener('hashchange', handleRoute);

  function handleRoute(){
    if(!currentUser){ show('view-signin'); return; }
    const path = getPath();
    if(path === '/' || path.startsWith('/table')){
      show('view-table');
      return;
    }
    // element route e.g. "/hydrogen" or "/element-1"
    const slug = path.replace(/^\/+|\/+$/g,'');
    if(slug){
      openAtomBySlug(slug);
      return;
    }
    show('view-table');
  }

  // ====== AUTH ======
  document.getElementById('btn-google').addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      await auth.signInWithPopup(provider);
    }catch(err){
      alert('Sign-in failed: '+ err.message);
    }
  });

  document.getElementById('btn-logout').addEventListener('click', ()=> auth.signOut());
  document.getElementById('btn-logout2').addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{
    currentUser = user;
    if(!user){
      show('view-signin');
      return;
    }
    // set user badge
    const emailEl = document.getElementById('userEmail');
    const photoEl = document.getElementById('userPhoto');
    emailEl.textContent = user.email || 'Signed in';
    if(user.photoURL){ photoEl.src = user.photoURL; photoEl.style.display='block'; }

    // load elements
    attachDBListeners();
    // go to table by default
    routeTo('/table');
  });

  // ====== DB LISTENERS ======
  let dbAttached = false;
  function attachDBListeners(){
    if(dbAttached) return; dbAttached = true;
    db.ref('elements').on('value', snap=>{
      elementsCache = snap.val() || {};
      renderTable();
      // If currently on atom, re-open to refresh
      if(getPath() && getPath() !== '/' && !getPath().startsWith('/table')){
        const slug = getPath().replace(/^\/+|\/+$/g,'');
        openAtomBySlug(slug, true);
      }
    });
  }

  // ====== PERIODIC TABLE LAYOUT ======
  // Main grid (18 columns). Use 0 for empty.
  const mainLayout = [
    // Row 1 (H, He)
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
    // Row 2 (Li, Be,  gap,  B..Ne)
    [3,4,0,0,0,0,0,0,0,0,0,0,5,6,7,8,9,10],
    // Row 3 (Na, Mg, gap, Al..Ar)
    [11,12,0,0,0,0,0,0,0,0,0,0,13,14,15,16,17,18],
    // Row 4 (K..Kr)
    [19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36],
    // Row 5 (Rb..Xe)
    [37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54],
    // Row 6 (Cs, Ba, gap, Hf..Rn)
    [55,56,0,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86],
    // Row 7 (Fr, Ra, gap, Rf..Og)
    [87,88,0,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118],
  ];
  // f-block rows (lanthanides & actinides), 15 columns starting at group 4 position
  const fBlock1 = [57,58,59,60,61,62,63,64,65,66,67,68,69,70,71];
  const fBlock2 = [89,90,91,92,93,94,95,96,97,98,99,100,101,102,103];

  // ====== RENDER TABLE ======
  const gridMain = document.getElementById('grid-main');
  const gridF = document.getElementById('grid-f');
  const gridF2 = document.getElementById('grid-f2');

  function renderTable(){
    // Main grid
    gridMain.innerHTML = '';
    mainLayout.forEach(row => {
      row.forEach(num => {
        if(num===0){
          const div = document.createElement('div');
          div.className='cell empty';
          gridMain.appendChild(div);
          return;
        }
        const data = elementsCache[num] || {};
        const cell = document.createElement('div');
        cell.className='cell';
        if(data.color) cell.style.background = data.color;
        cell.dataset.num = num;
        cell.title = (data.name||'') + (data.shortName? (' ('+data.shortName+')') : '')
        const meta = document.createElement('div'); meta.className='meta';
        const numEl = document.createElement('div'); numEl.className='num'; numEl.textContent = num;
        const symEl = document.createElement('div'); symEl.className='sym'; symEl.textContent = data.shortName||'';
        meta.append(numEl, symEl);
        const symbol = document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName? data.shortName : num;
        const name = document.createElement('div'); name.className='name'; name.textContent = data.name||'';
        cell.append(meta, symbol, name);
        // interactions
        cell.addEventListener('click', ()=> onCellClick(num));
        cell.addEventListener('dblclick', (e)=> onCellDblClick(e, num));
        gridMain.appendChild(cell);
      });
    });

    // f-block labels row
    gridF.innerHTML = '';
    // Leading label spacer to align under group 4 (we'll show a label at col1)
    const label1 = document.createElement('div'); label1.className='cell fblock-label'; label1.textContent='Lanthanides (57–71)';
    gridF.appendChild(label1);
    fBlock1.forEach(num=>{
      const data = elementsCache[num] || {};
      const cell = document.createElement('div'); cell.className='cell'; if(data.color) cell.style.background=data.color; cell.dataset.num=num;
      const meta = document.createElement('div'); meta.className='meta';
      const numEl = document.createElement('div'); numEl.className='num'; numEl.textContent = num;
      const symEl = document.createElement('div'); symEl.className='sym'; symEl.textContent = data.shortName||'';
      meta.append(numEl, symEl);
      const symbol = document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName? data.shortName : num;
      const name = document.createElement('div'); name.className='name'; name.textContent = data.name||'';
      cell.append(meta, symbol, name);
      cell.addEventListener('click', ()=> onCellClick(num));
      cell.addEventListener('dblclick', (e)=> onCellDblClick(e, num));
      gridF.appendChild(cell);
    });

    // actinides row
    gridF2.innerHTML='';
    const label2 = document.createElement('div'); label2.className='cell fblock-label'; label2.textContent='Actinides (89–103)';
    gridF2.appendChild(label2);
    fBlock2.forEach(num=>{
      const data = elementsCache[num] || {};
      const cell = document.createElement('div'); cell.className='cell'; if(data.color) cell.style.background=data.color; cell.dataset.num=num;
      const meta = document.createElement('div'); meta.className='meta';
      const numEl = document.createElement('div'); numEl.className='num'; numEl.textContent = num;
      const symEl = document.createElement('div'); symEl.className='sym'; symEl.textContent = data.shortName||'';
      meta.append(numEl, symEl);
      const symbol = document.createElement('div'); symbol.className='symbol'; symbol.textContent = data.shortName? data.shortName : num;
      const name = document.createElement('div'); name.className='name'; name.textContent = data.name||'';
      cell.append(meta, symbol, name);
      cell.addEventListener('click', ()=> onCellClick(num));
      cell.addEventListener('dblclick', (e)=> onCellDblClick(e, num));
      gridF2.appendChild(cell);
    });
  }

  function onCellClick(num){
    const data = elementsCache[num];
    let slug = data && data.slug ? data.slug : ('element-'+num);
    routeTo('/'+slug);
  }

  function onCellDblClick(e, num){
    if(!currentUser || currentUser.email !== OWNER_EMAIL) return; // only owner
    openOwnerModal(num);
  }

  // ====== OWNER MODAL ======
  const backdrop = document.getElementById('ownerModal');
  const inSymbol = document.getElementById('inSymbol');
  const inName = document.getElementById('inName');
  const inProtons = document.getElementById('inProtons');
  const inElectrons = document.getElementById('inElectrons');
  const inNeutrons = document.getElementById('inNeutrons');
  const inColor = document.getElementById('inColor');

  document.getElementById('btn-cancel').addEventListener('click', ()=> backdrop.classList.remove('open'));
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.classList.remove('open')});

  document.getElementById('btn-save').addEventListener('click', async ()=>{
    if(currentAtomic==null) return;
    const num = currentAtomic;
    const symbol = (inSymbol.value||'').trim();
    const name = (inName.value||'').trim();
    const protons = Math.max(0, parseInt(inProtons.value||'0'));
    const electrons = Math.max(0, parseInt(inElectrons.value||'0'));
    const neutrons = Math.max(0, parseInt(inNeutrons.value||'0'));
    const color = inColor.value || '#1a1e2f';
    const slug = (name? name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'') : ('element-'+num));

    const payload = { shortName: symbol, name, protons, electrons, neutrons, color, slug };
    try{
      await db.ref('elements/'+num).update(payload);
      backdrop.classList.remove('open');
    }catch(err){
      alert('Save failed: '+ err.message);
    }
  });

  function openOwnerModal(num){
    currentAtomic = num;
    const data = elementsCache[num] || {};
    document.getElementById('modalTitle').textContent = `Edit Element #${num}`;
    inSymbol.value = data.shortName||'';
    inName.value = data.name||'';
    inProtons.value = data.protons!=null? data.protons : '';
    inElectrons.value = data.electrons!=null? data.electrons : '';
    inNeutrons.value = data.neutrons!=null? data.neutrons : '';
    inColor.value = data.color||'#1a1e2f';
    backdrop.classList.add('open');
  }

  // ====== ATOM VIEW (three.js) ======
  let renderer, scene, camera, controls;
  let nucleusSolid, nucleusGroup, orbitGroups = [], electronGroups = [];
  let animId = null;

  const host = document.getElementById('rendererHost');
  const toggleNucleus = document.getElementById('toggleNucleus');
  const atomTitle = document.getElementById('atomTitle');
  const aboutBtn = document.getElementById('btn-about');
  const aboutSheet = document.getElementById('aboutSheet');
  const aboutFrame = document.getElementById('aboutFrame');
  const aboutTitle = document.getElementById('aboutTitle');
  const aboutClose = document.getElementById('aboutClose');
  document.getElementById('btn-back').addEventListener('click', ()=> routeTo('/table'));

  aboutBtn.addEventListener('click', ()=> aboutSheet.classList.add('open'));
  aboutClose.addEventListener('click', ()=> aboutSheet.classList.remove('open'));

  function resetThree(){
    if(animId) cancelAnimationFrame(animId);
    if(renderer){ renderer.dispose(); host.innerHTML=''; }
    orbitGroups = []; electronGroups=[]; nucleusGroup=null; nucleusSolid=null;
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setSize(host.clientWidth, host.clientHeight);
    host.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x07080e);

    const fov = 45; const aspect = host.clientWidth/host.clientHeight; const near=0.1; const far=1000;
    camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
    camera.position.set(0, 1.2, 6);

    const light = new THREE.PointLight(0xffffff, 1.2, 100); light.position.set(10,10,10); scene.add(light);
    const amb = new THREE.AmbientLight(0x666666); scene.add(amb);

    // OrbitControls (if available in your three.js build). Fallback simple controls if not.
    try{
      // If you have OrbitControls available as THREE.OrbitControls
      if(THREE.OrbitControls){
        controls = new THREE.OrbitControls(camera, renderer.domElement);
      }
    }catch(e){}
    if(!controls){
      // minimal rotate controls
      let isDown=false, lx=0, ly=0, rx=0, ry=0;
      renderer.domElement.addEventListener('pointerdown', e=>{isDown=true; lx=e.clientX; ly=e.clientY});
      window.addEventListener('pointerup', ()=>{isDown=false});
      window.addEventListener('pointermove', e=>{ if(!isDown) return; rx += (e.clientX-lx)*0.003; ry += (e.clientY-ly)*0.003; lx=e.clientX; ly=e.clientY; camera.position.x = 6*Math.sin(rx); camera.position.z = 6*Math.cos(rx); camera.position.y = Math.max(0.6, Math.min(3, camera.position.y - (e.movementY*0.01))); camera.lookAt(0,0,0); });
      renderer.domElement.addEventListener('wheel', e=>{ camera.position.multiplyScalar(1 + (e.deltaY>0?0.05:-0.05)); });
    }

    window.addEventListener('resize', ()=>{
      if(!renderer) return;
      renderer.setSize(host.clientWidth, host.clientHeight);
      camera.aspect = host.clientWidth/host.clientHeight; camera.updateProjectionMatrix();
    });
  }

  function buildAtomView(data){
    resetThree();

    // Nucleus solid
    const nucleusGeom = new THREE.SphereGeometry(0.6, 48, 48);
    const nucleusMat = new THREE.MeshPhongMaterial({color:0xffffff, shininess:80, emissive:0x0, transparent:true, opacity:0.95});
    nucleusSolid = new THREE.Mesh(nucleusGeom, nucleusMat);
    scene.add(nucleusSolid);

    // Inner nucleus particles (protons/neutrons)
    nucleusGroup = new THREE.Group();
    const pCount = Math.max(0, parseInt(data.protons||0));
    const nCount = Math.max(0, parseInt(data.neutrons||0));

    const pGeom = new THREE.SphereGeometry(0.08, 16, 16);
    const pMat = new THREE.MeshStandardMaterial({color:0x10B981}); // green
    const nGeom = new THREE.SphereGeometry(0.08, 16, 16);
    const nMat = new THREE.MeshStandardMaterial({color:0xF59E0B}); // orange

    const innerR = 0.5; // inside solid nucleus
    for(let i=0;i<pCount;i++){
      const m = new THREE.Mesh(pGeom, pMat);
      const v = randomPointInSphere(innerR);
      m.position.set(v.x, v.y, v.z);
      nucleusGroup.add(m);
    }
    for(let i=0;i<nCount;i++){
      const m = new THREE.Mesh(nGeom, nMat);
      const v = randomPointInSphere(innerR);
      m.position.set(v.x, v.y, v.z);
      nucleusGroup.add(m);
    }
    nucleusGroup.visible = false; // default off
    scene.add(nucleusGroup);

    // Orbits & electrons
    const eTotal = Math.max(0, parseInt(data.electrons||0));
    const shells = distributeElectrons(eTotal); // [count per shell]

    const orbitMat = new THREE.LineBasicMaterial({color:0x9AA4B2});
    shells.forEach((count, idx)=>{
      const n = idx+1;
      const radius = 1.0 + (n*0.6);
      // Orbit ring
      const circleGeom = circleGeometry(radius, 128);
      const ring = new THREE.LineLoop(circleGeom, orbitMat);
      scene.add(ring);
      orbitGroups.push(ring);
      // Electrons
      const group = new THREE.Group();
      for(let i=0;i<count;i++){
        const angle = (i/count) * Math.PI*2;
        const eGeom = new THREE.SphereGeometry(0.07, 16, 16);
        const eMat = new THREE.MeshStandardMaterial({color:0xE8ECF1});
        const eMesh = new THREE.Mesh(eGeom, eMat);
        eMesh.userData = { angle, radius, speed: 0.3/(n + 0.5) };
        eMesh.position.set(Math.cos(angle)*radius, 0, Math.sin(angle)*radius);
        group.add(eMesh);
      }
      electronGroups.push(group);
      scene.add(group);
    });

    toggleNucleus.checked = false;
    applyToggle();

    animate();
  }

  function animate(){
    animId = requestAnimationFrame(animate);
    // rotate electrons
    electronGroups.forEach(group=>{
      group.children.forEach(e=>{
        const ud = e.userData; if(!ud) return;
        ud.angle += ud.speed * 0.02; // slow
        e.position.set(Math.cos(ud.angle)*ud.radius, 0, Math.sin(ud.angle)*ud.radius);
      });
    });
    renderer.render(scene, camera);
  }

  function applyToggle(){
    const showNucleus = toggleNucleus.checked;
    // When ON → hide orbits & electrons, show inner nucleons; hide solid shell
    orbitGroups.forEach(o=> o.visible = !showNucleus);
    electronGroups.forEach(g=> g.visible = !showNucleus);
    nucleusGroup.visible = showNucleus;
    nucleusSolid.visible = !showNucleus;
  }
  toggleNucleus.addEventListener('change', applyToggle);

  function randomPointInSphere(r){
    // simple random inside sphere
    let x,y,z; do{
      x = (Math.random()*2-1); y=(Math.random()*2-1); z=(Math.random()*2-1);
    }while(x*x + y*y + z*z > 1);
    return new THREE.Vector3(x*r, y*r, z*r);
  }

  function circleGeometry(radius, segments){
    const geom = new THREE.BufferGeometry();
    const pts = [];
    for(let i=0;i<segments;i++){
      const a = (i/segments)*Math.PI*2; pts.push(radius*Math.cos(a), 0, radius*Math.sin(a));
    }
    geom.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
    return geom;
  }

  function distributeElectrons(total){
    const shells = [];
    let n=1, remaining = total;
    while(remaining>0 && shells.length<7){ // up to 7 shells is plenty for demo
      const cap = 2*n*n; // 2n^2
      const take = Math.min(cap, remaining);
      shells.push(take);
      remaining -= take; n++;
    }
    return shells;
  }

  // ====== OPEN ATOM BY SLUG ======
  async function openAtomBySlug(slug, fromRefresh){
    // find element with slug
    let foundNum = null, data=null;
    // direct lookup pass
    for(const [numStr, v] of Object.entries(elementsCache)){
      if(v && v.slug === slug){ foundNum = parseInt(numStr); data = v; break; }
    }
    // If not found and slug is element-<num>
    if(!foundNum){
      const m = slug.match(/^element-(\d{1,3})$/);
      if(m){ foundNum = parseInt(m[1]); data = elementsCache[foundNum]||{ protons: foundNum, electrons: foundNum, neutrons: 0, name: 'Element '+foundNum, shortName: ''}; }
    }
    // If still not found, try direct name match
    if(!foundNum){
      for(const [numStr, v] of Object.entries(elementsCache)){
        if(v && v.name && v.name.toLowerCase() === slug){ foundNum = parseInt(numStr); data=v; break; }
      }
    }

    if(!foundNum){
      // fallback to table
      routeTo('/table');
      return;
    }

    document.getElementById('aboutTitle').textContent = (data.name||('Element '+foundNum));
    document.getElementById('aboutFrame').src = data.name ? ('https://en.wikipedia.org/wiki/'+ encodeURIComponent(data.name)) : 'about:blank';

    // title
    atomTitle.textContent = data.name || ('Element '+foundNum);
    show('view-atom');

    buildAtomView({
      protons: data.protons ?? foundNum,
      neutrons: data.neutrons ?? 0,
      electrons: data.electrons ?? foundNum
    });
  }

  // ====== ABOUT SHEET CLOSE on ESC ======
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      aboutSheet.classList.remove('open');
      document.getElementById('ownerModal').classList.remove('open');
    }
  });

  // Initial render table (blank) & route
  renderTable();
  handleRoute();
</script></body>
                                                  </html>
