<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Periodic Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Three.js -->
  <script src="three.js"></script>
  <style>
    :root {
      --bg: #181c24;
      --surface: #232733;
      --primary: #5e8fff;
      --block: #202432;
      --block-hover: #28304a;
      --block-active: #3661e2;
      --owner: #ffbe76;
      --text: #f1f1f1;
      --muted: #979fae;
      --modal-bg: rgba(25,28,36,0.97);
      --accent: #00d8d6;
      --danger: #ff5e57;
      --border: #303446;
    }
    * {box-sizing: border-box;}
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100%;
    }
    .centered {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      transition: background 0.3s;
    }
    .auth-card {
      background: var(--surface);
      padding: 2.5rem 2.5rem;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px #000a;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      max-width: 95vw;
    }
    .auth-card h1 {
      margin: 0;
      font-size: 2.2rem;
      font-weight: bold;
      letter-spacing: 1px;
      color: var(--primary);
      text-shadow: 0 2px 12px #0003;
    }
    .google-btn {
      background: #22242e;
      color: var(--muted);
      border: none;
      border-radius: 0.7rem;
      font-size: 1.1rem;
      padding: 0.85em 2.5em 0.85em 3em;
      font-weight: 500;
      box-shadow: 0 2px 8px #0002;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background 0.2s;
      position: relative;
      outline: none;
    }
    .google-btn:hover, .google-btn:focus {
      background: #34384a;
      color: #fff;
    }
    .google-btn img {
      height: 1.7em;
      position: absolute;
      left: 1em;
      background: #fff;
      border-radius: 100%;
      padding: 0.15em;
    }
    .signout-btn {
      position: fixed;
      top: 18px;
      right: 22px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 5px 18px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      z-index: 50;
      transition: background 0.2s, color 0.2s;
    }
    .signout-btn:hover { background: var(--surface); color: var(--danger); }
    /* Periodic Table */
    #periodic-table-container {
      width: 100vw; height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 0; margin: 0;
      background: var(--bg);
      overflow: auto;
    }
    .periodic-table-grid {
      display: grid;
      grid-gap: 0.5vw;
      margin: 3vw 0 2vw;
      padding: 0 1vw;
      background: transparent;
      /* Custom grid for periodic table */
      grid-template-columns: repeat(18, minmax(32px, 1fr));
      grid-auto-rows: minmax(42px, 6vw);
      width: 95vw;
      max-width: 1450px;
      min-width: 320px;
      max-height: 88vh;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: 1.5vw;
    }
    .ptable-block {
      background: var(--block);
      border-radius: 0.6vw;
      color: var(--text);
      box-shadow: 0 2px 10px #0003;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-end;
      cursor: pointer;
      position: relative;
      transition: background 0.13s, box-shadow 0.13s;
      min-width: 32px;
      min-height: 36px;
      overflow: hidden;
      border: 1px solid var(--border);
      will-change: background;
      user-select: none;
    }
    .ptable-block:hover, .ptable-block.active {
      background: var(--block-hover);
      box-shadow: 0 4px 20px #5e8fff22;
      z-index: 2;
    }
    .ptable-block.owner {
      border: 2px solid var(--owner);
      box-shadow: 0 0 0 3px var(--owner)44;
    }
    .ptable-block .block-top {
      width: 100%; display: flex; align-items: center; justify-content: flex-end;
      padding: 0.23em 0.38em 0 0;
      font-size: 0.9em;
      font-weight: bold;
      position: absolute; top: 0; left: 0;
      z-index: 2;
    }
    .ptable-block .block-atomic { font-size: inherit; }
    .ptable-block .block-symbol {
      font-size: 1.04em;
      font-weight: 600;
      margin: 0 0 0 0.35em;
      color: var(--primary);
      letter-spacing: 1px;
    }
    .ptable-block .block-bottom {
      width: 100%; text-align: right;
      padding: 0 0.3em 0.2em 0;
      font-size: 0.85em;
      opacity: 0.88;
      font-weight: 400;
      color: var(--muted);
      position: absolute; bottom: 0; left: 0;
      z-index: 2;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ptable-block .block-number-only {
      position: absolute; top: 0.5em; left: 0.7em;
      font-size: 1.1em; opacity: 0.45;
      font-weight: bold;
      color: var(--muted);
    }
    .ptable-row-label {
      grid-column: 1 / span 18;
      color: var(--muted); opacity: 0.55;
      text-align: left; font-size: 0.8em;
      margin-left: 0.3em;
    }
    /* Modal */
    .modal-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(20,23,29,0.64);
      z-index: 90;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInBg 0.15s;
    }
    @keyframes fadeInBg {
      from {background: rgba(20,23,29,0);}
      to {background: rgba(20,23,29,0.64);}
    }
    .modal-card {
      background: var(--modal-bg);
      color: var(--text);
      border-radius: 1.2rem;
      box-shadow: 0 6px 32px #000a;
      padding: 2.2rem 2.8rem 2rem 2.8rem;
      min-width: 290px;
      max-width: 95vw;
      display: flex;
      flex-direction: column;
      gap: 1.2em;
      animation: modalPopIn 0.18s cubic-bezier(.39,1.5,.64,1);
      position: relative;
    }
    @keyframes modalPopIn {
      from {transform: translateY(40px) scale(0.93);}
      to {transform: none;}
    }
    .modal-close {
      position: absolute;
      top: 15px; right: 22px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 1.8em;
      cursor: pointer;
      transition: color 0.13s;
      z-index: 2;
    }
    .modal-close:hover { color: var(--danger); }
    .modal-card label {
      font-size: 1em;
      color: var(--muted);
      margin-bottom: 0.3em;
    }
    .modal-card input[type="text"], 
    .modal-card input[type="number"] {
      width: 100%;
      padding: 0.6em 1.1em;
      margin-bottom: 0.5em;
      border-radius: 0.6em;
      border: 1px solid var(--border);
      background: #232733;
      color: var(--text);
      font-size: 1.05em;
      outline: none;
      transition: border .17s;
    }
    .modal-card input[type="text"]:focus, 
    .modal-card input[type="number"]:focus {
      border: 1.5px solid var(--primary);
      background: #252b39;
    }
    .modal-card input[type="color"] {
      width: 2.5em; height: 2.5em;
      border-radius: 100%;
      border: none;
      outline: 2px solid var(--border);
      margin-left: 0.6em;
      background: transparent;
      cursor: pointer;
      vertical-align: middle;
    }
    .modal-card .row { display: flex; gap: 1.5em; align-items: center; }
    .modal-card .modal-actions {
      display: flex; gap: 1.2em; margin-top: 0.8em; justify-content: flex-end;
    }
    .modal-card .modal-actions button {
      padding: 0.5em 1.9em;
      border-radius: 0.8em;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 1.07em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.12s;
      margin-left: 0.32em;
    }
    .modal-card .modal-actions button:active {
      background: #3661e2;
    }
    .modal-card .modal-actions .cancel-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    /* Atom 3D View */
    #atom-view-container {
      width: 100vw;
      min-height: 100vh;
      background: var(--bg);
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }
    #atom-canvas-wrap {
      width: 100vw;
      max-width: 620px;
      margin: 0 auto;
      height: 60vw;
      max-height: 62vh;
      min-height: 320px;
      display: flex; align-items: center; justify-content: center;
      background: none;
      position: relative;
      touch-action: none;
    }
    #atom-toolbar {
      display: flex; gap: 1.7em;
      align-items: center;
      margin: 14px auto 0 auto;
      padding: 0.6em 1.7em 0.3em 1.7em;
      background: var(--surface);
      border-radius: 2em;
      box-shadow: 0 2px 12px #0002;
      font-size: 1.09em;
      color: var(--muted);
    }
    #atom-toolbar label {
      display: flex; align-items: center; gap: 0.6em;
      cursor: pointer;
      font-size: 1em;
    }
    #atom-toolbar input[type="checkbox"] {
      accent-color: var(--accent);
      width: 1.13em; height: 1.13em;
    }
    #atom-legend {
      margin-top: 0.5em;
      font-size: 0.97em;
      color: var(--muted);
      display: flex; gap: 1.3em; align-items: center;
    }
    #atom-legend .dot {
      display: inline-block;
      width: 0.94em; height: 0.94em;
      border-radius: 50%;
      margin-right: 0.33em;
      vertical-align: middle;
    }
    /* About Modal Animation Up */
    .about-modal-bg {
      position: fixed;
      left: 0; right: 0; bottom: 0; top: 0;
      background: rgba(20,23,29,0.72);
      z-index: 120;
      display: flex; align-items: flex-end; justify-content: center;
      animation: fadeInBg 0.13s;
    }
    .about-modal-card {
      background: var(--modal-bg);
      color: var(--text);
      width: 100vw;
      max-width: 670px;
      min-height: 290px;
      min-width: 220px;
      border-radius: 2.2em 2.2em 0 0;
      box-shadow: 0 -8px 40px #000c;
      padding: 1.5em 0.7em 0.7em 0.7em;
      animation: aboutPopIn 0.22s cubic-bezier(.39,1.5,.64,1);
      position: relative;
      overflow: hidden;
      display: flex; flex-direction: column; align-items: stretch;
    }
    @keyframes aboutPopIn {
      from {transform: translateY(100%);}
      to {transform: none;}
    }
    .about-modal-close {
      position: absolute;
      top: 11px; right: 22px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 2em;
      cursor: pointer;
      transition: color 0.13s;
      z-index: 2;
    }
    .about-modal-close:hover { color: var(--danger); }
    .about-modal-card h2 {
      margin: 0 0 1em 1em;
      font-size: 1.2em;
      color: var(--primary);
      font-weight: 600;
      letter-spacing: 1px;
    }
    .about-wiki-iframe {
      width: 100%; min-height: 55vh; border: none;
      border-radius: 0 0 2em 2em;
      background: #fff;
      margin-bottom: 0.7em;
    }
    .about-modal-card .about-loading {
      color: var(--muted);
      text-align: center;
      padding: 2em 0;
    }
    /* About button */
    #about-btn {
      position: relative;
      margin: 1.7em auto 0 auto;
      display: block;
      background: var(--surface);
      color: var(--primary);
      border: none;
      border-radius: 1.4em;
      font-size: 1.1em;
      font-weight: 500;
      padding: 0.7em 2.3em;
      cursor: pointer;
      box-shadow: 0 2px 10px #0002;
      transition: background 0.14s, color 0.14s;
      z-index: 5;
    }
    #about-btn:hover { background: var(--primary); color: #fff; }
    /* Responsive */
    @media (max-width: 950px) {
      .periodic-table-grid { grid-auto-rows: minmax(37px, 7vw); }
      .modal-card { padding: 1.2rem 1.2rem 1.1rem 1.2rem; }
      #atom-canvas-wrap { height: 70vw; }
    }
    @media (max-width: 700px) {
      .periodic-table-grid { grid-auto-rows: minmax(32px, 9vw); }
      #atom-canvas-wrap { max-width: 99vw; height: 84vw; min-height: 210px; }
      .modal-card { min-width: 95vw; }
    }
    @media (max-width: 500px) {
      .periodic-table-grid { grid-gap: 0.23vw; }
      #atom-toolbar { padding: 0.5em 0.6em 0.2em 0.6em; font-size: 1em;}
      .modal-card { padding: 0.8rem 0.3rem 1.1rem 0.5rem; }
      .about-modal-card { min-height: 180px; }
    }
    @media (max-width: 400px) {
      #atom-canvas-wrap { min-height: 130px; }
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" class="centered" style="display:none;">
    <div class="auth-card">
      <h1>3D Periodic Table</h1>
      <button class="google-btn" id="google-signin-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
        Sign in with Google
      </button>
      <div style="margin-top:1.4em;font-size:0.98em;color:var(--muted);opacity:0.68;">
        Visualize atoms in 3D &mdash; Edit data as <b>owner</b>
      </div>
    </div>
  </div>
  <!-- Main Screens (hidden initially) -->
  <button id="signout-btn" class="signout-btn" style="display:none;">Sign Out</button>
  <div id="periodic-table-container" style="display:none;">
    <div class="periodic-table-grid" id="ptable-grid"></div>
  </div>
  <div id="atom-view-container" style="display:none;">
    <div id="atom-toolbar" style="display:flex;">
      <label>
        <input type="checkbox" id="nucleus-detail-toggle">
        Hide orbits and show nucleus details
      </label>
    </div>
    <div id="atom-canvas-wrap"></div>
    <div id="atom-legend" style="display:none;">
      <span><span class="dot" style="background:#f44336;"></span>Proton</span>
      <span><span class="dot" style="background:#ffc107;"></span>Neutron</span>
      <span><span class="dot" style="background:#40c4ff;"></span>Electron</span>
    </div>
    <button id="about-btn">About</button>
  </div>
  <!-- Modals will be inserted here -->
  <div id="modal-root"></div>
  <!-- About Modal -->
  <div id="about-modal-root"></div>
  <script>
    // --- CONFIG ---
    const OWNER_EMAIL = "samiulhaquerafsan@gmail.com";
    // Firebase config: <-- REPLACE THIS with your own config object! -->
    const firebaseConfig = {
      apiKey: "AIzaSyCMEqtaxOodPnwMKkrSVZrcjLMmj3oefB0",
  authDomain: "chatstudio-agent.firebaseapp.com",
  databaseURL: "https://chatstudio-agent-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatstudio-agent",
  storageBucket: "chatstudio-agent.firebasestorage.app",
  messagingSenderId: "626338448826",
  appId: "1:626338448826:web:67936971701c3466d90983",
  measurementId: "G-ZHNZHMYC0B"
    };

    // --- GLOBAL STATE ---
    let app = null, auth = null, db = null;
    let currentUser = null;
    let elementsData = {}; // {atomicNumber: {symbol, name, proton, electron, neutron, color}}
    let ptableOrder = []; // Array of {row, col, atomic}
    let currentRoute = '/';
    let unsubscribeDB = null;

    // --- UI ELEMENTS ---
    const $authScreen = document.getElementById('auth-screen');
    const $googleBtn = document.getElementById('google-signin-btn');
    const $signoutBtn = document.getElementById('signout-btn');
    const $ptableContainer = document.getElementById('periodic-table-container');
    const $ptableGrid = document.getElementById('ptable-grid');
    const $atomView = document.getElementById('atom-view-container');
    const $atomToolbar = document.getElementById('atom-toolbar');
    const $atomLegend = document.getElementById('atom-legend');
    const $atomCanvasWrap = document.getElementById('atom-canvas-wrap');
    const $nucleusToggle = document.getElementById('nucleus-detail-toggle');
    const $aboutBtn = document.getElementById('about-btn');
    const $modalRoot = document.getElementById('modal-root');
    const $aboutModalRoot = document.getElementById('about-modal-root');
    // --- Periodic Table Layout ---
    // [row, col, atomic number] for each element (1-118)
    const PTABLE_LAYOUT = [
      // Row, Col, Atomic Number - H to He
      [1, 1, 1],[1, 18, 2],
      // 2nd row
      [2, 1, 3],[2, 2, 4],[2, 13, 5],[2, 14, 6],[2, 15, 7],[2, 16, 8],[2, 17, 9],[2, 18, 10],
      // 3rd row
      [3, 1, 11],[3, 2, 12],[3, 13, 13],[3, 14, 14],[3, 15, 15],[3, 16, 16],[3, 17, 17],[3, 18, 18],
      // 4th row (K - Kr)
      [4,1,19],[4,2,20],[4,3,21],[4,4,22],[4,5,23],[4,6,24],[4,7,25],[4,8,26],[4,9,27],[4,10,28],[4,11,29],[4,12,30],[4,13,31],[4,14,32],[4,15,33],[4,16,34],[4,17,35],[4,18,36],
      // 5th row (Rb-Xe)
      [5,1,37],[5,2,38],[5,3,39],[5,4,40],[5,5,41],[5,6,42],[5,7,43],[5,8,44],[5,9,45],[5,10,46],[5,11,47],[5,12,48],[5,13,49],[5,14,50],[5,15,51],[5,16,52],[5,17,53],[5,18,54],
      // 6th row (Cs - Rn)
      [6,1,55],[6,2,56],
      [6,3,72],[6,4,73],[6,5,74],[6,6,75],[6,7,76],[6,8,77],[6,9,78],[6,10,79],[6,11,80],[6,12,81],[6,13,82],[6,14,83],[6,15,84],[6,16,85],[6,17,86],[6,18,118],
      // Lanthanides (57-71)
      [8,3,57],[8,4,58],[8,5,59],[8,6,60],[8,7,61],[8,8,62],[8,9,63],[8,10,64],[8,11,65],[8,12,66],[8,13,67],[8,14,68],[8,15,69],[8,16,70],[8,17,71],
      // 7th row (Fr - Og)
      [7,1,87],[7,2,88],
      [7,3,104],[7,4,105],[7,5,106],[7,6,107],[7,7,108],[7,8,109],[7,9,110],[7,10,111],[7,11,112],[7,12,113],[7,13,114],[7,14,115],[7,15,116],[7,16,117],[7,17,118],
      // Actinides (89-103)
      [9,3,89],[9,4,90],[9,5,91],[9,6,92],[9,7,93],[9,8,94],[9,9,95],[9,10,96],[9,11,97],[9,12,98],[9,13,99],[9,14,100],[9,15,101],[9,16,102],[9,17,103],
      // Insert missing elements for 6th/7th row, 3-17 columns
      [6,3,57],[6,4,58],[6,5,59],[6,6,60],[6,7,61],[6,8,62],[6,9,63],[6,10,64],[6,11,65],[6,12,66],[6,13,67],[6,14,68],[6,15,69],[6,16,70],[6,17,71],
      [7,3,89],[7,4,90],[7,5,91],[7,6,92],[7,7,93],[7,8,94],[7,9,95],[7,10,96],[7,11,97],[7,12,98],[7,13,99],[7,14,100],[7,15,101],[7,16,102],[7,17,103]
    ];
    // Remove duplicates from PTABLE_LAYOUT
    (function(){
      let seen = {};
      ptableOrder = PTABLE_LAYOUT.filter(e => {
        if(seen[e[2]]) return false;
        seen[e[2]] = true;
        return true;
      });
    })();

    // Map: symbol, name, default color for each element (1-118)
    // To save space, only a few are filled. In real use, owner should enter these, or you can fill all.
    const ELEMENTS_INFO = {
      1: {symbol: "H", name: "Hydrogen", color: "#e6f7ff"},
      2: {symbol: "He", name: "Helium", color: "#ffe6fb"},
      3: {symbol: "Li", name: "Lithium", color: "#ccffe6"},
      4: {symbol: "Be", name: "Beryllium", color: "#ccfff2"},
      5: {symbol: "B", name: "Boron", color: "#f3ffe6"},
      6: {symbol: "C", name: "Carbon", color: "#e6e6e6"},
      7: {symbol: "N", name: "Nitrogen", color: "#e6f0ff"},
      8: {symbol: "O", name: "Oxygen", color: "#e6fcff"},
      9: {symbol: "F", name: "Fluorine", color: "#e6ffe6"},
      10: {symbol: "Ne", name: "Neon", color: "#ffe6e6"},
      // ... (fill as needed up to 118)
      26: {symbol: "Fe", name: "Iron", color: "#e7e7e7"},
      79: {symbol: "Au", name: "Gold", color: "#ffe595"},
      80: {symbol: "Hg", name: "Mercury", color: "#b9e2ff"},
      82: {symbol: "Pb", name: "Lead", color: "#c1b7b7"},
      118: {symbol: "Og", name: "Oganesson", color: "#fce6fc"}
    };

    // --- FIREBASE INIT ---
    firebase.initializeApp(firebaseConfig);
    app = firebase.app();
    auth = firebase.auth();
    db = firebase.database();

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        showSignOut();
        showMainScreen();
        listenPeriodicTable();
        route(location.pathname);
      } else {
        showAuthScreen();
        cleanMainScreens();
      }
    });
    function showAuthScreen() {
      $authScreen.style.display = "";
      $ptableContainer.style.display = "none";
      $atomView.style.display = "none";
      $signoutBtn.style.display = "none";
    }
    function showSignOut() { $signoutBtn.style.display = ""; }
    function cleanMainScreens() {
      $ptableContainer.style.display = "none";
      $atomView.style.display = "none";
    }
    $googleBtn.onclick = () => {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    };
    $signoutBtn.onclick = () => {
      auth.signOut();
    };

    // --- PERIODIC TABLE LISTEN ---
    function listenPeriodicTable() {
      if (unsubscribeDB) unsubscribeDB();
      unsubscribeDB = db.ref('elements').on('value', snap => {
        elementsData = snap.val() || {};
        // Merge with default info for missing fields
        for (let i = 1; i <= 118; ++i) {
          if (!elementsData[i]) elementsData[i] = {};
          if (!elementsData[i].symbol && ELEMENTS_INFO[i]) elementsData[i].symbol = ELEMENTS_INFO[i].symbol;
          if (!elementsData[i].name && ELEMENTS_INFO[i]) elementsData[i].name = ELEMENTS_INFO[i].name;
          if (!elementsData[i].color && ELEMENTS_INFO[i]) elementsData[i].color = ELEMENTS_INFO[i].color;
        }
        if (currentRoute === '/' || currentRoute === '/ptable') renderPeriodicTable();
        if (currentRoute.startsWith('/atom/')) updateAtomScreenData();
      });
    }

    // --- ROUTING ---
    window.onpopstate = function() {
      route(location.pathname);
    };
    function route(path) {
      if (!currentUser) { showAuthScreen(); return; }
      currentRoute = path;
      if (path === '/' || path === '/ptable') {
        renderPeriodicTable();
        $ptableContainer.style.display = "";
        $atomView.style.display = "none";
      } else if (path.match(/^\/([a-z0-9\-]+)$/i)) {
        let slug = path.slice(1).toLowerCase();
        showAtomScreen(slug);
      } else {
        // fallback
        history.replaceState({}, '', '/');
        renderPeriodicTable();
        $ptableContainer.style.display = "";
        $atomView.style.display = "none";
      }
    }
    function pushRoute(url) {
      history.pushState({}, '', url);
      route(url);
    }

    // ---- RENDER PERIODIC TABLE ----
    function renderPeriodicTable() {
      $authScreen.style.display = "none";
      $ptableContainer.style.display = "";
      $atomView.style.display = "none";
      $ptableGrid.innerHTML = "";
      // 9 rows, 18 columns
      let gridMap = {}; // key: row-col, value: atomic number
      for (let cell of ptableOrder) {
        let [row, col, atomic] = cell;
        gridMap[`${row}-${col}`] = atomic;
      }
      let maxRow = 9, maxCol = 18;
      for (let r = 1; r <= maxRow; ++r) {
        for (let c = 1; c <= maxCol; ++c) {
          let atomic = gridMap[`${r}-${c}`];
          let el = null;
          if (atomic) {
            let data = elementsData[atomic] || {};
            let isOwner = currentUser && currentUser.email === OWNER_EMAIL;
            let color = data.color || "#232733";
            el = document.createElement('div');
            el.className = "ptable-block";
            if (isOwner) el.classList.add('owner');
            el.style.background = color || "var(--block)";
            el.tabIndex = 0;
            el.setAttribute('data-atomic', atomic);
            el.setAttribute('role', 'button');
            // Block content
            if (data.symbol && data.name) {
              el.innerHTML = `
                <div class="block-top">
                  <span class="block-atomic">${atomic}</span>
                  <span class="block-symbol">${data.symbol}</span>
                </div>
                <div class="block-bottom">${data.name}</div>
              `;
            } else {
              el.innerHTML = `<span class="block-number-only">${atomic}</span>`;
            }
            // Click/DblClick
            let clickTimer = null;
            el.onclick = (e) => {
              if (clickTimer) {
                clearTimeout(clickTimer); clickTimer = null;
              }
              clickTimer = setTimeout(() => {
                pushRoute('/' + (data.name ? slugify(data.name) : 'element'+atomic));
              }, 210);
            };
            el.ondblclick = (e) => {
              if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; }
              if (currentUser && currentUser.email === OWNER_EMAIL)
                showEditModal(atomic);
            };
          } else {
            el = document.createElement('div');
            el.style.background = 'transparent';
            el.style.pointerEvents = 'none';
          }
          $ptableGrid.appendChild(el);
        }
      }
    }
    // --- EDIT MODAL FOR OWNER ---
    function showEditModal(atomic) {
      let data = elementsData[atomic] || {};
      let modal = document.createElement('div');
      modal.className = "modal-bg";
      modal.innerHTML = `
        <div class="modal-card">
          <button class="modal-close" title="Close">&times;</button>
          <h2>Edit Element #${atomic}</h2>
          <form id="edit-form">
            <label>Short Name (symbol):<br>
              <input type="text" name="symbol" required maxlength="3" value="${data.symbol || ''}" autocomplete="off">
            </label>
            <label>Full Name:<br>
              <input type="text" name="name" required maxlength="18" value="${data.name || ''}" autocomplete="off">
            </label>
            <div class="row">
              <label>Proton:
                <input type="number" name="proton" min="1" max="300" required value="${data.proton || atomic}">
              </label>
              <label>Electron:
                <input type="number" name="electron" min="1" max="300" required value="${data.electron || atomic}">
              </label>
              <label>Neutron:
                <input type="number" name="neutron" min="0" max="400" required value="${data.neutron || atomic}">
              </label>
            </div>
            <div class="row" style="margin-top:0.3em;">
              <label>Block Color:
                <input type="color" name="color" value="${data.color || '#232733'}">
              </label>
            </div>
            <div class="modal-actions">
              <button type="button" class="cancel-btn">Cancel</button>
              <button type="submit">Save</button>
            </div>
          </form>
        </div>
      `;
      // Close modal
      modal.querySelector('.modal-close').onclick = modal.querySelector('.cancel-btn').onclick = () => {
        $modalRoot.innerHTML = '';
      };
      // Submit
      modal.querySelector('#edit-form').onsubmit = function(e) {
        e.preventDefault();
        let fd = new FormData(this);
        let symbol = fd.get('symbol').trim();
        let name = fd.get('name').trim();
        let proton = parseInt(fd.get('proton'));
        let electron = parseInt(fd.get('electron'));
        let neutron = parseInt(fd.get('neutron'));
        let color = fd.get('color');
        if (!symbol || !name) return;
        // Update database
        db.ref('elements/'+atomic).update({
          symbol, name, proton, electron, neutron, color
        }).then(() => {
          $modalRoot.innerHTML = '';
        });
      };
      $modalRoot.innerHTML = '';
      $modalRoot.appendChild(modal);
    }

    // --- ATOM 3D SCREEN ---
    function showAtomScreen(slug) {
      $authScreen.style.display = "none";
      $ptableContainer.style.display = "none";
      $atomView.style.display = "";
      $atomCanvasWrap.innerHTML = "";
      $aboutBtn.style.display = "";
      // Find atomic number from slug
      let atomic = null, found = false;
      slug = slug.toLowerCase();
      for (let i=1; i<=118; ++i) {
        let nm = (elementsData[i]?.name || ELEMENTS_INFO[i]?.name || '').toLowerCase();
        let sym = (elementsData[i]?.symbol || '').toLowerCase();
        if (slugify(nm) === slug || sym === slug || ('element'+i)===slug) {
          atomic = i; found = true; break;
        }
      }
      if (!found) {
        $atomCanvasWrap.innerHTML = `<div style="color:var(--muted);text-align:center;margin-top:2em;">Element not found.</div>`;
        $atomToolbar.style.display = "none"; $atomLegend.style.display = "none";
        return;
      }
      renderAtom3D(atomic);
      $atomToolbar.style.display = "";
      $atomLegend.style.display = $nucleusToggle.checked ? "" : "none";
      // Checkbox: nucleus toggle
      $nucleusToggle.checked = false;
      $nucleusToggle.onchange = () => {
        renderAtom3D(atomic, $nucleusToggle.checked);
        $atomLegend.style.display = $nucleusToggle.checked ? "" : "none";
      };
      // About button
      $aboutBtn.onclick = () => { showAboutModal(atomic); };
      // For live update:
      updateAtomScreenData = () => {
        renderAtom3D(atomic, $nucleusToggle.checked);
      };
    }
    // --- Atom 3D Rendering (three.js) ---
    let atom3DObj = null, atomRenderer = null, atomScene = null, atomCamera = null, atomAnimId = null, atomOrbitControls = null;
    function renderAtom3D(atomic, nucleusDetail=false) {
      // Clear previous
      if (atom3DObj) { if(atomRenderer) atomRenderer.dispose && atomRenderer.dispose(); atom3DObj=null; }
      if(atomAnimId) cancelAnimationFrame(atomAnimId);
      $atomCanvasWrap.innerHTML = "";
      let w = Math.min($atomCanvasWrap.offsetWidth || 420, 560);
      let h = Math.min($atomCanvasWrap.offsetHeight || 380, 520);
      let canvas = document.createElement('canvas');
      canvas.style.width = "100%"; canvas.style.height = "100%";
      canvas.width = w; canvas.height = h;
      $atomCanvasWrap.appendChild(canvas);

      // Data
      let data = elementsData[atomic] || {};
      let protons = parseInt(data.proton) || atomic;
      let electrons = parseInt(data.electron) || atomic;
      let neutrons = parseInt(data.neutron) || atomic;
      // Scene setup
      atomRenderer = new THREE.WebGLRenderer({canvas, alpha: true, antialias: true});
      atomRenderer.setClearColor(0x181c24, 1);
      atomRenderer.setSize(w, h, false);
      atomScene = new THREE.Scene();
      atomCamera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
      atomCamera.position.set(0, 0, 7);
      // Lighting
      let ambient = new THREE.AmbientLight(0xffffff, 0.7);
      let dir = new THREE.DirectionalLight(0xffffff, 0.7);
      dir.position.set(6, 6, 8);
      atomScene.add(ambient, dir);
      // Atom nucleus
      let nucleusGroup = new THREE.Group();
      if (nucleusDetail) {
        // Show protons/neutrons as small colored balls
        let pRadius = 0.23, nRadius = 0.21;
        let nuclRadius = 0.7 + 0.06*Math.sqrt(protons+neutrons);
        let angleStep = Math.PI * 2 / Math.max(1, protons+neutrons);
        let pt = 0, nt = 0;
        for (let i=0; i<protons+neutrons; ++i) {
          let isProton = (i<protons);
          let phi = Math.acos(-1 + 2*(i+0.5)/(protons+neutrons));
          let theta = Math.PI * (1 + Math.sqrt(5)) * i;
          let r = nuclRadius * 0.82;
          let x = r * Math.cos(theta) * Math.sin(phi);
          let y = r * Math.sin(theta) * Math.sin(phi);
          let z = r * Math.cos(phi);
          let geom = new THREE.SphereGeometry(isProton?pRadius:nRadius, 18, 18);
          let mat = new THREE.MeshPhongMaterial({color: isProton?0xf44336:0xffc107});
          let mesh = new THREE.Mesh(geom, mat);
          mesh.position.set(x, y, z);
          nucleusGroup.add(mesh);
        }
      } else {
        // Nucleus as white sphere
        let nuclRadius = 0.85 + 0.08*Math.sqrt(protons+neutrons);
        let sphere = new THREE.Mesh(
          new THREE.SphereGeometry(nuclRadius, 38, 24),
          new THREE.MeshPhongMaterial({color: 0xffffff, shininess: 56})
        );
        nucleusGroup.add(sphere);
      }
      atomScene.add(nucleusGroup);

      // Electron Orbits
      let electronGroup = new THREE.Group();
      if (!nucleusDetail) {
        // Calculate shell structure: 2n^2
        let electronsLeft = electrons, shells = [], shellCap = [2,8,18,32,50,72,98];
        for(let n=0; electronsLeft>0 && n<shellCap.length; ++n) {
          let count = Math.min(electronsLeft, shellCap[n]);
          shells.push(count); electronsLeft -= count;
        }
        let baseRadius = 1.4 + 0.15*Math.sqrt(protons+neutrons);
        for(let s=0; s<shells.length; ++s) {
          let shellR = baseRadius+ s*0.65;
          // Orbit ring
          let ringGeom = new THREE.TorusGeometry(shellR, 0.02, 10, 80);
          let ring = new THREE.Mesh(ringGeom, new THREE.MeshBasicMaterial({color: 0x40c4ff, transparent:true, opacity:0.33}));
          ring.rotation.x = Math.PI/2;
          electronGroup.add(ring);
        }
        // Electrons
        atom3DObj = {electronMeshes:[]};
        for(let s=0; s<shells.length; ++s) {
          let n = shells[s], shellR = baseRadius+s*0.65;
          for(let e=0; e<n; ++e) {
            let theta = (2*Math.PI/n)*e;
            let phi = Math.PI/4 + (s%2)*Math.PI/8;
            let geom = new THREE.SphereGeometry(0.11, 12, 12);
            let mat = new THREE.MeshPhongMaterial({color:0x40c4ff, shininess:59});
            let mesh = new THREE.Mesh(geom, mat);
            mesh.userData = {shell:s, e:e, n:n, shellR, baseTheta:theta, basePhi:phi+0.12*e};
            mesh.position.set(
              shellR*Math.cos(theta)*Math.sin(phi),
              shellR*Math.sin(theta)*Math.sin(phi),
              shellR*Math.cos(phi)
            );
            electronGroup.add(mesh);
            atom3DObj.electronMeshes.push(mesh);
          }
        }
      }
      atomScene.add(electronGroup);

      // Camera orbit controls (rotate with drag/touch)
      let isDragging = false, lastX=0, lastY=0, rotX=0, rotY=0;
      canvas.onpointerdown = function(e) { isDragging = true; lastX = e.clientX; lastY = e.clientY; };
      canvas.onpointerup = function(e) { isDragging = false; };
      canvas.onpointerleave = function(e) { isDragging = false; };
      canvas.onpointermove = function(e) {
        if(!isDragging) return;
        let dx = e.clientX-lastX, dy = e.clientY-lastY;
        rotY += dx*0.012; rotX += dy*0.012;
        rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotX));
        lastX = e.clientX; lastY = e.clientY;
      };
      // Animate
      function animateAtom() {
        // Animate electrons
        if (atom3DObj && atom3DObj.electronMeshes) {
          let t = performance.now()/1200;
          atom3DObj.electronMeshes.forEach(mesh=>{
            let {shell,e,n,shellR,baseTheta,basePhi} = mesh.userData;
            let theta = baseTheta + t*(1.1+0.13*shell);
            let phi = basePhi + Math.sin(t*0.3+shell)*0.19;
            mesh.position.set(
              shellR*Math.cos(theta)*Math.sin(phi),
              shellR*Math.sin(theta)*Math.sin(phi),
              shellR*Math.cos(phi)
            );
          });
        }
        atomScene.rotation.y = rotY;
        atomScene.rotation.x = rotX;
        atomRenderer.render(atomScene, atomCamera);
        atomAnimId = requestAnimationFrame(animateAtom);
      }
      animateAtom();
    }
    // --- About Modal (Wikipedia iframe) ---
    function showAboutModal(atomic) {
      let data = elementsData[atomic] || {};
      let name = data.name || ELEMENTS_INFO[atomic]?.name || '';
      let wikiTitle = encodeURIComponent(name);
      let wikiSrc = `https://en.wikipedia.org/api/rest_v1/page/html/${wikiTitle}`;
      let modal = document.createElement('div');
      modal.className = "about-modal-bg";
      modal.innerHTML = `
        <div class="about-modal-card">
          <button class="about-modal-close" title="Close">&times;</button>
          <h2>About ${name} (#${atomic})</h2>
          <div class="about-wiki-iframe" id="wiki-iframe-wrap">
            <div class="about-loading">Loading Wikipedia...</div>
          </div>
        </div>
      `;
      // Close
      modal.querySelector('.about-modal-close').onclick = () => { $aboutModalRoot.innerHTML = ''; };
      $aboutModalRoot.innerHTML = '';
      $aboutModalRoot.appendChild(modal);
      // Load wiki article (iframe)
      fetch(wikiSrc)
      .then(r=>r.text())
      .then(html=>{
        let wrap = modal.querySelector('#wiki-iframe-wrap');
        wrap.innerHTML = `<iframe srcdoc='${html.replace(/<script[\s\S]*?<\/script>/gi, "")}' style="width:100%;min-height:55vh;border:none;background:#fff;"></iframe>`;
      })
      .catch(e=>{
        modal.querySelector('#wiki-iframe-wrap').innerHTML = '<div class="about-loading">No Wikipedia data found!</div>';
      });
    }

    // --- UTILS ---
    function slugify(text) {
      return (text||'').toString().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    // --- INIT: Routing on load
    window.addEventListener('DOMContentLoaded', ()=>{
      if (currentUser) route(location.pathname);
      else showAuthScreen();
    });
  </script>
</body>
  </html>
